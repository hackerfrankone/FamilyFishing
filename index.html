<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Fishing Fun</title>
  <base href="https://hackerfrankone.github.io/FamilyFishing/">
  <link rel="icon" type="image/jpeg" href="images/favicon.jpg?v=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://pagead2.googlesyndication.com https://www.googletagservices.com https://partner.googleadservices.com https://adservice.google.* https://securepubads.g.doubleclick.net https://www.googleadservices.com https://*.google.com https://*.googlesyndication.com https://*.doubleclick.net; style-src 'self' 'unsafe-inline'; img-src 'self' https://hackerfrankone.github.io https://raw.githubusercontent.com https://www.paypalobjects.com https://upload.wikimedia.org https://www.google.com https://www.gstatic.com https://pagead2.googlesyndication.com https://tpc.googlesyndication.com https://*.googlesyndication.com https://*.doubleclick.net data:; connect-src 'self' https://worldtimeapi.org https://www.google-analytics.com https://api.github.com https://raw.githubusercontent.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://tpc.googlesyndication.com https://www.googletagservices.com https://partner.googleadservices.com https://adservice.google.* https://securepubads.g.doubleclick.net https://www.googleadservices.com https://*.google.com https://*.googlesyndication.com https://*.doubleclick.net; frame-src 'self' https://tpc.googlesyndication.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://*.googlesyndication.com https://*.doubleclick.net; child-src 'self' https://tpc.googlesyndication.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://*.googlesyndication.com https://*.doubleclick.net; worker-src 'self' https://pagead2.googlesyndication.com https://*.googlesyndication.com https://*.doubleclick.net; media-src 'self' https://pagead2.googlesyndication.com https://*.googlesyndication.com https://*.doubleclick.net; font-src 'self' https://fonts.gstatic.com https://*.googlesyndication.com; form-action 'self' https://www.paypal.com; object-src 'none'; base-uri 'self';">
  <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-6EBHYE2X44"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9237571676231200" crossorigin="anonymous"></script>
  <style>
    body {
      background-image: url('https://hackerfrankone.github.io/FamilyFishing/images/background.png?v=1');
      background-color: #000;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
    }
    @media (max-width: 768px) {
      body { background-position: center; }
    }
    @media (max-width: 480px) {
      body { background-position: center; }
    }
    a { color: #00ffff; text-decoration: none; }
    .top-bar { text-align: center; margin-bottom: 2rem; }
    .social-buttons { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .facebook-button img, .youtube-button img { width: 60px; height: 60px; border-radius: 50%; transition: filter 0.3s ease; box-shadow: 0 0 8px rgba(255, 255, 255, 0.5); }
    .facebook-button:hover img, .youtube-button:hover img { filter: brightness(150%); }
    .discord-button, .donate-button, .archive-button, .tackle-button, .submit-fish-button, .rules-button {
      width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: bold; text-decoration: none; transition: filter 0.3s ease; box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }
    .discord-button { background-color: #5865F2; color: white; }
    .donate-button { background-color: #FFD700; color: white; border: none; cursor: pointer; }
    .archive-button { background-color: #808080; color: white; }
    .tackle-button { background-color: #006400; color: white; }
    .submit-fish-button { background-color: #FFA500; color: white; }
    .rules-button { background-color: #cc0000; color: white; padding: 0; }
    .discord-button:hover, .archive-button:hover, .tackle-button:hover { filter: brightness(150%); }
    .donate-button:hover, .submit-fish-button:hover { filter: brightness(75%); }
    .rules-button:hover { background-color: #ff0000; }
    .tournament-info {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      margin: 1rem auto 0;
      margin-bottom: 0;
      text-align: center;
    }
    .tournament-info p {
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      text-align: center;
    }
    .tournament-info .main-text {
      font-size: 1.5rem;
      font-weight: bold;
      color: #FFD700;
      white-space: nowrap;
      background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent dark background */
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }
    .tournament-info .sub-text {
      font-size: 1rem;
      margin-top: 0.1rem;
      background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent dark background */
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }
    @media (max-width: 768px) {
      .tournament-info {
        padding: 0.4rem 0.8rem;
      }
      .tournament-info .main-text {
        font-size: 1.2rem;
      }
      .tournament-info .sub-text {
        font-size: 0.9rem;
        margin-top: 0.2rem;
      }
    }
    .countdown {
      font-size: 2rem;
      font-weight: bold;
      max-width: 600px;
      margin: 0.2rem auto;
      text-align: center;
      color: #FFD700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent dark background */
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }
    .countdown span {
      background: none;
    }
    .countdown-red {
      color: #ff0000 !important;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }
.feedback {
  color: red;
  font-size: 0.9rem;
  text-align: center;
  margin-top: 0.5rem;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
}

.feedback a {
  color: red; /* Optional: ensure links inside also appear red */
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
}
    .paypal-form {
      display: grid;
      justify-items: center;
      gap: 0.3rem;
      margin-top: 0.5rem;
      margin-bottom: 0;
    }
    .paypal-button {
      background-color: #FFD700;
      color: #000;
      font-weight: bold;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      padding: 10px 2rem;
      cursor: pointer;
      transition: filter 0.3s ease;
    }
    .paypal-button:hover {
      filter: brightness(150%);
    }
    .leaderboard-container {
      text-align: center;
      margin-top: 0.2rem;
      position: relative;
      overflow: visible;
    }
    .leaderboard-container img {
      display: block;
      margin: 0 auto;
      max-width: 350px;
      height: auto;
      border-radius: 8px;
      transition: transform 0.2s ease;
      transform-origin: center;
      cursor: zoom-in;
      user-select: none;
      -webkit-user-select: none;
      touch-action: pinch-zoom;
    }
    .winner-fish-gallery {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .winner-fish-gallery img {
      max-width: 150px;
      height: auto;
      border-radius: 8px;
      transition: transform 0.2s ease;
      cursor: zoom-in;
    }
    .leaderboard-container .no-image-text {
      display: block;
      margin: 0 auto;
      max-width: 350px;
      font-size: 1.5rem;
      font-weight: bold;
      color: #FFD140;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      text-align: center;
    }
    .current-leaderboard-title, .current-winner-title {
      color: #FFD700;
      font-weight: bold;
      font-size: 1.5rem;
      font-family: Arial, Helvetica, sans-serif;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent dark background */
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }
    .current-leaderboard-title {
      margin-top: 0.5rem;
      display: block; /* Keep as block since it might need full width */
    }
    .current-winner-title {
      margin-top: 0;
      display: inline-block; /* Changed to inline-block to wrap tightly around text */
      margin-left: auto;
      margin-right: auto;
    }
    .current-leaderboard-title span, .current-winner-title span {
      background: none;
      padding: 0;
      border-radius: 0;
      display: inline;
    }
    .identifier-container {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1000;
    }
    .identifier-container .month-identifier {
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      margin: 0.2rem 0;
      font-family: Arial, Helvetica, sans-serif;
      font-weight: bold;
      color: #FFFFFF;
      font-size: 1.5rem;
    }
    .angler-sidebar {
      position: fixed;
      top: 3rem;
      left: 1rem;
      padding: 1rem;
      border-radius: 8px;
      max-width: 250px;
      max-height: 500px;
      overflow-y: auto;
      z-index: 1000;
    }
    .angler-sidebar h3 {
      color: yellow;
      font-weight: bold;
      font-family: 'Arial', sans-serif;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      margin: 0 0 0.5rem;
      font-size: 1.2rem;
    }
    .angler-sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .angler-sidebar ul::-webkit-scrollbar {
      width: 8px;
    }
    .angler-sidebar ul::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    }
    .angler-sidebar ul::-webkit-scrollbar-thumb {
      background: yellow;
      border-radius: 4px;
    }
    .angler-sidebar ul::-webkit-scrollbar-thumb:hover {
      background: #FFD140;
    }
    .angler-item {
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
      justify-content: flex-start;
    }
    .angler-name {
      display: block;
      color: yellow;
      font-weight: bold;
      font-family: 'Arial', sans-serif;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      font-size: 1.2rem;
      transition: color 0.3s ease;
    }
    .angler-name:hover {
      color: #FFD140;
    }
    .dropdown {
      display: none;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 4px;
      padding: 0.5rem;
      margin-top: 0.3rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      font-size: 0.9rem;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      max-width: 180px;
      position: relative;
      overflow: hidden;
    }
    .dropdown.show {
      display: block !important;
    }
    .dropdown p {
      margin: 0.3rem 0;
    }
    .dropdown ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 0.3rem;
    }
    .dropdown li {
      margin: 0;
      font-size: 0.9rem;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .fish-length {
      color: #00ffff;
      font-size: 0.7rem;
      margin-bottom: 0.2rem;
    }
    .fish-image {
      width: 60px;
      height: auto;
      border-radius: 4px;
      margin: 0.2rem;
      border: none;
      outline: none;
      transition: transform 0.2s ease;
      transform-origin: center;
      cursor: zoom-in;
      user-select: none;
      -webkit-user-select: none;
      touch-action: pinch-zoom;
    }
    .no-image-text {
      color: #FFD140;
      font-size: 0.7rem;
      text-align: center;
      margin: 0.2rem;
      width: 60px;
    }
    @media (max-width: 768px) {
      .countdown {
        font-size: 1.5rem;
      }
      .identifier-container {
        position: static;
        margin: 1rem auto;
        max-width: 100%;
        text-align: center;
      }
      .angler-sidebar {
        position: static;
        margin: 1rem auto;
        max-width: 100%;
        text-align: center;
      }
      .angler-item {
        justify-content: center;
      }
      .identifier-container .month-identifier {
        font-size: 1.2rem;
        color: #FFFFFF;
      }
      .paypal-form {
        margin-top: 0.3rem;
      }
      .paypal-button {
        font-size: 0.9rem;
        padding: 8px 1.5rem;
      }
      .leaderboard-container {
        margin-top: 0.1rem;
      }
      .dropdown {
        max-width: 100%;
      }
      .fish-image {
        width: 50px;
      }
      .no-image-text {
        width: 50px;
        font-size: 0.6rem;
      }
      .fish-length {
        font-size: 0.6rem;
      }
      .dropdown ul {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      }
      .winner-fish-gallery img {
        max-width: 120px;
      }
    }
    ins.adsbygoogle {
      display: block;
      margin: 0.5rem auto;
      text-align: center;
      min-height: 90px;
    }
    :root {
      --primary-color: #FFA500;
    }
  </style>
  <script>
    window.dataLayer = window.dataLayer || []; 
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date()); 
    gtag('config', 'G-6EBHYE2X44', { 'anonymize_ip': true });

    function handleImageError(imgElement) {
      const container = imgElement.parentElement;
      const noImageText = document.createElement('div');
      noImageText.className = 'no-image-text';
      noImageText.textContent = 'Family Fishing Fun';
      container.appendChild(noImageText);
      imgElement.style.display = 'none';
      imgElement.src = 'https://hackerfrankone.github.io/FamilyFishing/images/current/fallback_bass.png?v=' + Date.now();
      imgElement.style.display = 'block';
      imgElement.onerror = () => {
        container.removeChild(imgElement);
        noImageText.style.display = 'block';
      };
    }

    const monthCodes = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    function mulberry32(seed) { 
      return function() { 
        let t = seed += 0x6D2B79F5; 
        t = Math.imul(t ^ t >>> 15, t | 1); 
        t ^= t + Math.imul(t ^ t >>> 7, t | 61); 
        return ((t ^ t >>> 14) >>> 0) / 4294967296; 
      }; 
    }

    function generateSeededCode(seed, useSeed = true) { 
      const random = useSeed ? mulberry32(seed) : Math.random; 
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; 
      let code = ''; 
      for (let i = 0; i < 3; i++) code += letters.charAt(Math.floor(random() * letters.length)); 
      return code; 
    }

    async function fetchCurrentTime() { 
      const cachedTime = localStorage.getItem('serverTime'); 
      const cacheTimestamp = localStorage.getItem('serverTimeTimestamp'); 
      const cacheAge = cacheTimestamp ? Date.now() - parseInt(cacheTimestamp) : Infinity; 
      if (cachedTime && cacheAge < 3600000) return new Date(cachedTime); 
      try { 
        const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC', { signal: new AbortController().signal, timeout: 5000 }); 
        const data = await response.json(); 
        const serverTime = new Date(data.utc_datetime); 
        localStorage.setItem('serverTime', serverTime.toISOString()); 
        localStorage.setItem('serverTimeTimestamp', Date.now().toString()); 
        return serverTime; 
      } catch (error) { 
        return new Date(); 
      } 
    }

    async function fetchWithRetry(url, maxRetries = 3, timeout = 5000) { 
      for (let i = 0; i < maxRetries; i++) { 
        try { 
          const response = await fetch(url, { signal: new AbortController().signal, timeout }); 
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); 
          return response; 
        } catch (error) { 
          if (i === maxRetries - 1) throw error; 
        } 
      } 
    }

    async function loadCurrentWinner(winnerData) { 
      const winnerElement = document.getElementById("current-winner-name"); 
      const winnerGallery = document.getElementById("winner-fish-gallery");
      if (!winnerElement || !winnerGallery) return;

      try {
        const today = await fetchCurrentTime();
        const monthNumber = today.getMonth();
        const year = today.getFullYear();
        const monthCode = monthCodes[monthNumber];

        if (winnerData && winnerData.winner && winnerData.fishList) {
          winnerElement.textContent = `Current Winner: ${winnerData.winner} (${winnerData.totalInches}" total)`;

          const fishImages = winnerData.fishList.map((fish, index) => {
            const imageUrl = fish.image ? `https://raw.githubusercontent.com/hackerfrankone/FamilyFishing/main/images/submissions/${fish.image}` : '';
            return imageUrl 
              ? `<img id="winner-fish-image-${index}" src="${imageUrl}" alt="${fish.length} inch bass by ${winnerData.winner}" onerror="handleImageError(this);">`
              : `<div class="no-image-text">No fish image</div>`;
          }).join('');

          winnerGallery.innerHTML = fishImages || '<div class="no-image-text">No fish submitted</div>';

          winnerData.fishList.forEach((fish, index) => {
            if (fish.image) {
              initializeFishImageZoom(`winner-fish-${index}`);
            }
          });

          localStorage.setItem('currentWinner', JSON.stringify({ 
            month: `${monthCode} ${year}`, 
            angler: winnerData.winner, 
            totalInches: winnerData.totalInches,
            fishList: winnerData.fishList
          }));
        } else {
          winnerElement.textContent = 'No winner yet';
          winnerGallery.innerHTML = '<div class="no-image-text">No fish submitted</div>';
        }
      } catch (error) {
        winnerElement.textContent = 'No winner yet';
        winnerGallery.innerHTML = '<div class="no-image-text">Error loading winner</div>';
      }
    }

    async function checkAndArchivePreviousWinner(today, monthNumber, year) { 
      const lastMonthDate = new Date(year, monthNumber - 1, 1); 
      const lastMonthCode = monthCodes[lastMonthDate.getMonth()]; 
      const lastMonthYear = lastMonthDate.getFullYear(); 
      const lastMonth = `${lastMonthCode} ${lastMonthYear}`; 
      const currentWinnerData = JSON.parse(localStorage.getItem('currentWinner') || '{}'); 
      const storedMonthYear = localStorage.getItem('monthYear'); 
      if (storedMonthYear !== `${year}-${monthNumber}` && currentWinnerData.month === lastMonth) { 
        const winner = currentWinnerData.angler; 
        const totalInches = currentWinnerData.totalInches;
        const fishList = currentWinnerData.fishList || [];
        let archiveData = []; 
        try { 
          const response = await fetchWithRetry('https://raw.githubusercontent.com/hackerfrankone/FamilyFishing/main/images/archive/archive.json'); 
          if (response.ok) archiveData = await response.json(); 
        } catch (error) {} 
        if (!archiveData.find(item => item.month === lastMonth)) { 
          archiveData.push({ 
            month: lastMonth, 
            angler: winner, 
            totalInches: totalInches,
            fishList: fishList
          }); 
          const newArchiveContent = JSON.stringify(archiveData, null, 2); 
          console.log(`Update archive.json with: ${newArchiveContent}`); 
        } 
      } 
    }

    let isUpdatingMonth = false; 
    async function updateMonth() { 
      if (isUpdatingMonth) return; 
      isUpdatingMonth = true; 
      try { 
        const today = await fetchCurrentTime(); 
        const monthNumber = today.getMonth(); 
        const year = today.getFullYear(); 
        const monthCode = monthCodes[monthNumber]; 
        const currentMonthYear = `${year}-${monthNumber}`; 
        if (localStorage.getItem('monthYear') !== currentMonthYear) { 
          localStorage.setItem('monthYear', currentMonthYear); 
          await checkAndArchivePreviousWinner(today, monthNumber, year); 
        } 
        let randomCode = year === 2025 && monthNumber === 4 ? 'QEF' : year === 2025 && monthNumber === 3 ? 'IKY' : year > 2025 || (year === 2025 && monthNumber >= 4) ? generateSeededCode(parseInt(`${year}${monthNumber.toString().padStart(2, '0')}`, true)) : generateSeededCode(0, false); 
        document.getElementById("month").textContent = monthCode; 
        document.getElementById("month-code").textContent = randomCode; 
        document.getElementById("biggest-bass-title").textContent = `${monthCode}'s Biggest Bass`; 
        document.getElementById("current-winner-name").textContent = `Current Winner: Loading...`; 
      } catch (error) {} 
      finally { 
        isUpdatingMonth = false; 
      } 
    }

    let serverTimeOffset = 0; 
    let countdownInterval = null; 
    async function initializeCountdown() { 
      try { 
        const serverTime = await fetchCurrentTime(); 
        serverTimeOffset = serverTime.getTime() - Date.now(); 
        updateCountdown(); 
      } catch (error) { 
        if (countdownInterval) { 
          clearInterval(countdownInterval); 
          countdownInterval = null; 
        } 
        updateCountdown(); 
      } 
    }

    function updateCountdown() { 
      const timerElement = document.getElementById("countdown-timer"); 
      const countdownElement = document.getElementById("countdown"); 
      if (!timerElement || !countdownElement) return; 
      const now = new Date(Date.now() + serverTimeOffset); 
      const year = now.getFullYear(); 
      const month = now.getMonth(); 
      const target = new Date(Date.UTC(year, month + 1, 1, 0, 0, 0)); 
      const timeDiff = target - now; 
      if (timeDiff <= 0) { 
        updateMonth(); 
        timerElement.textContent = "Tournament ended!"; 
        countdownElement.classList.remove('countdown-red'); 
        if (countdownInterval) { 
          clearInterval(countdownInterval); 
          countdownInterval = null; 
        } 
        return; 
      } 
      const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24)); 
      const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); 
      const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60)); 
      const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000); 
      timerElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`; 
      if (days <= 7) countdownElement.classList.add('countdown-red'); 
      else countdownElement.classList.remove('countdown-red'); 
    }

    function startCountdown() { 
      if (!countdownInterval) countdownInterval = setInterval(updateCountdown, 2000); 
    }

    async function loadAnglerList() { 
      const anglerList = document.getElementById("angler-list"); 
      if (!anglerList) return; 
      anglerList.innerHTML = "<li>Loading...</li>"; 
      try { 
        const anglerResponse = await fetchWithRetry('https://raw.githubusercontent.com/hackerfrankone/FamilyFishing/main/CSV/angler_list.csv?cachebust=' + new Date().getTime()); 
        const anglerText = await anglerResponse.text(); 
        const anglerNames = anglerText.split('\n').filter(line => line.trim()).slice(1).map(line => line.split(',')[0]?.trim()).filter(name => name); 

        let fishData = []; 
        try { 
          const fishResponse = await fetchWithRetry('https://raw.githubusercontent.com/hackerfrankone/FamilyFishing/main/CSV/fish_submissions.csv?cachebust=' + new Date().getTime()); 
          const fishText = await fishResponse.text(); 
          fishData = fishText.split('\n').filter(line => line.trim()).slice(1).map(line => { 
            const [angler, length, image] = line.split(','); 
            return { 
              angler: angler?.trim(), 
              length: parseFloat(length) || 0, 
              image: image?.trim() || '' 
            }; 
          }).filter(entry => entry.angler && entry.length > 0 && entry.image); 
        } catch (fishError) { 
          console.warn('No fish submissions found:', fishError); 
        } 

        const fishByAngler = {};
        let maxTotalInches = 0;
        let currentWinner = null;
        let winnerFishList = [];

        anglerNames.forEach(angler => { 
          fishByAngler[angler] = fishData.filter(fish => fish.angler === angler) 
            .sort((a, b) => { 
              const dateA = a.image ? a.image.match(/(\d{2})(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)(\d{4})/i) : null; 
              const dateB = b.image ? b.image.match(/(\d{2})(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)(\d{4})/i) : null; 
              if (dateA && dateB) { 
                const monthA = monthCodes.findIndex(m => m.toLowerCase().startsWith(dateA[2])) + 1; 
                const monthB = monthCodes.findIndex(m => m.toLowerCase().startsWith(dateB[2])) + 1; 
                return new Date(dateB[3], monthB - 1, dateB[1]) - new Date(dateA[3], monthA - 1, dateA[1]); 
              } 
              return 0; 
            }) 
            .slice(0, 5); 

          const totalInches = fishByAngler[angler].reduce((sum, fish) => sum + fish.length, 0);
          if (totalInches > maxTotalInches) {
            maxTotalInches = totalInches;
            currentWinner = angler;
            winnerFishList = fishByAngler[angler];
          }
        });

        if (currentWinner) {
          await loadCurrentWinner({
            winner: currentWinner,
            totalInches: maxTotalInches.toFixed(2),
            fishList: winnerFishList
          });
        } else {
          await loadCurrentWinner(null);
        }

        const anglerHtml = anglerNames.map(angler => { 
          const fishList = fishByAngler[angler] || []; 
          const fishCount = fishList.length; 
          const totalLength = fishList.reduce((sum, fish) => sum + fish.length, 0); 

          const fishItems = fishList.map((fish, index) => { 
            const imageUrl = fish.image ? `https://raw.githubusercontent.com/hackerfrankone/FamilyFishing/main/images/submissions/${fish.image}` : ''; 
            const imageHtml = imageUrl 
              ? `<img class="fish-image" id="fish-image-${angler.replace(/[^a-zA-Z0-9]/g, '')}-${index}" src="${imageUrl}" alt="${fish.length} inch bass by ${angler}" onerror="console.log('Image load failed for', this.src); this.style.display='none'; this.nextSibling.style.display='block';">` 
              : ''; 
            const noImageHtml = `<span class="no-image-text" style="display: ${imageUrl ? 'none' : 'block'};">No fish submitted</span>`; 
            return ` 
              <li> 
                <span class="fish-length">${fish.length} inches</span> 
                ${imageHtml}${noImageHtml} 
              </li> 
            `; 
          }).join(''); 
          const placeholders = Array.from({ length: 5 - fishCount }, () => ` 
            <li> 
              <span class="no-image-text">No fish submitted</span> 
            </li> 
          `).join(''); 
          const safeAnglerId = angler.replace(/[^a-zA-Z0-9]/g, ''); 
          return ` 
            <li class="angler-item"> 
              <div> 
                <span class="angler-name" onclick="toggleDropdown('${safeAnglerId}')" aria-expanded="false" aria-controls="dropdown-${safeAnglerId}">${angler}</span> 
                <div class="dropdown" id="dropdown-${safeAnglerId}"> 
                  <p>Fish Submitted: ${fishCount}</p> 
                  <ul>${fishItems}${placeholders}</ul> 
                  <p>Total: ${totalLength} inches</p> 
                </div> 
              </div> 
            </li> 
          `; 
        }).join(''); 
        anglerList.innerHTML = anglerHtml || '<li>No anglers registered.</li>'; 

        anglerNames.forEach(angler => { 
          const safeAnglerId = angler.replace(/[^a-zA-Z0-9]/g, ''); 
          fishByAngler[angler]?.forEach((fish, index) => { 
            if (fish.image) { 
              initializeFishImageZoom(`${safeAnglerId}-${index}`); 
            } 
          }); 
        }); 
      } catch (error) { 
        console.error("Failed to load angler list:", error); 
        anglerList.innerHTML = '<li>Error loading anglers. Please try again later.</li>'; 
        await loadCurrentWinner(null); 
      } 
    }

    function toggleDropdown(id) { 
      const dropdown = document.getElementById(`dropdown-${id}`); 
      const trigger = document.querySelector(`[aria-controls="dropdown-${id}"]`); 
      if (dropdown && trigger) { 
        const isHidden = !dropdown.classList.contains('show'); 
        document.querySelectorAll('.dropdown.show').forEach(d => d.classList.remove('show')); 
        document.querySelectorAll('[aria-expanded="true"]').forEach(t => t.setAttribute('aria-expanded', 'false')); 
        if (isHidden) { 
          dropdown.classList.add('show'); 
          trigger.setAttribute('aria-expanded', 'true'); 
        } 
      } 
    }

    function initializeFishImageZoom(imageId) {
      const image = document.getElementById(`fish-image-${imageId}`) || document.getElementById(`winner-fish-image-${imageId.split('-')[2]}`);
      if (!image) return;
      let scale = 1;
      const minScale = 0.5;
      const maxScale = 3;
      const scaleStep = 0.1;

      function updateZoom(newScale) {
        scale = Math.max(minScale, Math.min(maxScale, newScale));
        image.style.transform = `scale(${scale})`;
      }

      image.addEventListener('wheel', (event) => {
        event.preventDefault();
        const delta = event.deltaY > 0 ? -scaleStep : scaleStep;
        updateZoom(scale + delta);
      });

      image.addEventListener('dblclick', (event) => {
        event.preventDefault();
        scale = 1;
        image.style.transform = 'scale(1)';
      });

      let initialDistance = null;
      let initialScale = scale;

      image.addEventListener('touchstart', (event) => {
        if (event.touches.length === 2) {
          event.preventDefault();
          const touch1 = event.touches[0];
          const touch2 = event.touches[1];
          initialDistance = Math.hypot(
            touch1.pageX - touch2.pageX,
            touch1.pageY - touch2.pageY
          );
          initialScale = scale;
        }
      });

      image.addEventListener('touchmove', (event) => {
        if (event.touches.length === 2) {
          event.preventDefault();
          const touch1 = event.touches[0];
          const touch2 = event.touches[1];
          const currentDistance = Math.hypot(
            touch1.pageX - touch2.pageX,
            touch1.pageY - touch2.pageY
          );
          if (initialDistance) {
            const zoomFactor = currentDistance / initialDistance;
            updateZoom(initialScale * zoomFactor);
          }
        }
      });

      image.addEventListener('touchend', () => {
        initialDistance = null;
      });

      image.addEventListener('click', (event) => {
        event.preventDefault();
        const anglerName = image.closest('.angler-item')?.querySelector('.angler-name')?.textContent || image.alt.split('by ')[1];
        const fishLength = image.closest('li')?.querySelector('.fish-length')?.textContent.replace(' inches', '') || image.alt.match(/(\d+\.?\d*) inch/)?.[1];
        const cleanImageUrl = image.src.split('?v=')[0];
        const imageUrl = encodeURIComponent(cleanImageUrl);
        const viewerUrl = `https://hackerfrankone.github.io/FamilyFishing/image-viewer.html?image=${imageUrl}&angler=${encodeURIComponent(anglerName)}&length=${encodeURIComponent(fishLength)}`;
        window.open(viewerUrl, '_blank');
      });
    }

    document.addEventListener('DOMContentLoaded', function() { 
      window.dataLayer.push({event: 'pageview'}); 
      updateMonth(); 
      initializeCountdown(); 
      startCountdown(); 
      loadAnglerList(); 
      setInterval(updateMonth, 48 * 60 * 60 * 1000); 
      (adsbygoogle = window.adsbygoogle || []).push({}); 
    });
  </script>
</head>
<body>
  <div class="identifier-container">
    <p id="monthly-identifier" class="month-identifier"><span id="month"></span> Identifier: <span id="month-code"></span></p>
  </div>
  <div class="angler-sidebar">
    <h3>ANGLERS:</h3>
    <ul id="angler-list"><li>Loading...</li></ul>
  </div>
  <div class="top-bar">
    <div class="social-buttons">
      <form action="https://www.paypal.com/donate" method="post" target="_blank" rel="noopener">
        <input type="hidden" name="marketplace" value="US">
        <input type="hidden" name="hosted_button_id" value="AVS6RRJQXPTDS">
        <button type="submit" class="donate-button" tabindex="0">Donate</button>
      </form>
      <a href="pages/tackle.html" target="_blank" rel="noopener noreferrer" class="tackle-button" aria-label="Visit our Tackle" tabindex="0" onclick="alert('Coming soon'); return false;">Tackle</a>
      <a href="https://www.facebook.com/share/g/18orZuMkch/" target="_blank" rel="noopener noreferrer" class="facebook-button" aria-label="Visit our Facebook page" tabindex="0">
        <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook logo" width="60" height="60">
      </a>
      <a href="https://www.youtube.com/@usafamilyfishingfun" target="_blank" rel="noopener noreferrer" class="youtube-button" aria-label="Visit our YouTube channel" tabindex="0">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/YouTube_Logo_2017.svg" alt="YouTube logo">
      </a>
      <a href="https://discord.gg/SWxsq4q8wH" target="_blank" rel="noopener noreferrer" class="discord-button" aria-label="Join our Discord server" tabindex="0">Discord</a>
      <a href="pages/archive.html" target="_blank" rel="noopener noreferrer" class="archive-button" aria-label="View our archive" tabindex="0">Archive</a>
      <a href="https://www.dropbox.com/request/YwG0NvsfxiLX9Ciiypcy" target="_blank" rel="noopener noreferrer" class="submit-fish-button" aria-label="Submit Fish" tabindex="0">Submit Fish</a>
      <a href="PDFs/rules.pdf?v=2" target="_blank" rel="noopener" class="rules-button" aria-label="View Rules" tabindex="0">ðŸ“„ Rules</a>
    </div>
    <div class="tournament-info">
      <p class="main-text">1st Place: $200</p>
      <p class="main-text">Month long | 5 Bass limit | More anglers, More payout</p>
      <p class="sub-text">Tennessee Lakes Only</p>
      <p class="feedback">Feedback or questions: <a href="mailto:usa@familyfishing.fun" rel="noopener">usa@familyfishing.fun</a></p>
      <p class="countdown" id="countdown"><span>Tournament ends in: </span><span id="countdown-timer">Calculating...</span></p>
      <form action="https://www.paypal.com/ncp/payment/MQGR2KDA2VZP4" method="post" target="_blank" rel="noopener" class="paypal-form">
        <input type="submit" value="Join Tournament $20" class="paypal-button">
        <input type="hidden" name="item_name" value="Tournament Entry">
        <input type="hidden" name="notify_url" value="https://paypal-webhook.familyfishingfun2025.workers.dev">
        <img src="https://www.paypalobjects.com/images/Debit_Credit_APM.svg" alt="Accepted payment methods">
        <section style="font-size: 0.75rem;">Powered by <img src="https://www.paypalobjects.com/paypal-ui/logos/svg/paypal-wordmark-color.svg" alt="PayPal logo" style="height:0.875rem; vertical-align:middle;"></section>
      </form>
    </div>
  </div>
  <div class="leaderboard-container">
    <div class="current-winner-title"><span><strong id="current-winner-name">Current Winner: Loading...</strong></span></div>
    <div id="winner-fish-gallery" class="winner-fish-gallery"></div>
  </div>
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9237571676231200" data-ad-slot="auto" data-ad-format="auto" data-full-width-responsive="true"></ins>
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9237571676231200" data-ad-slot="auto" data-ad-format="auto" data-full-width-responsive="true"></ins>
</body>
</html> 
