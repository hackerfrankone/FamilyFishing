<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Fishing Fun</title>
  <base href="https://hackerfrankone.github.io/FamilyFishing/">
  <link rel="icon" type="image/jpeg" href="images/favicon.jpg?v=2">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://pagead2.googlesyndication.com https://www.googletagservices.com https://partner.googleadservices.com https://adservice.google.* https://securepubads.g.doubleclick.net https://www.googleadservices.com https://*.google.com https://*.googlesyndication.com https://*.doubleclick.net; style-src 'self' 'unsafe-inline'; img-src 'self' https://hackerfrankone.github.io https://raw.githubusercontent.com https://upload.wikimedia.org https://www.google.com https://www.gstatic.com https://pagead2.googlesyndication.com https://tpc.googlesyndication.com https://*.googlesyndication.com https://*.doubleclick.net https://*.dropbox.com https://*.dropboxusercontent.com data:; connect-src 'self' https://worldtimeapi.org https://www.google-analytics.com https://api.github.com https://raw.githubusercontent.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://tpc.googlesyndication.com https://www.googletagservices.com https://partner.googleadservices.com https://adservice.google.* https://securepubads.g.doubleclick.net https://www.googleadservices.com https://*.google.com https://*.googlesyndication.com https://*.dropbox.com https://*.dropboxapi.com https://your-backend.vercel.app; frame-src 'self' https://tpc.googlesyndication.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://*.googlesyndication.com https://*.doubleclick.net; child-src 'self' https://tpc.googlesyndication.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://*.googlesyndication.com https://*.doubleclick.net; worker-src 'self' https://pagead2.googlesyndication.com https://*.googlesyndication.com https://*.doubleclick.net; media-src 'self' https://pagead2.googlesyndication.com https://*.googlesyndication.com https://*.doubleclick.net; font-src 'self' https://fonts.gstatic.com https://*.googlesyndication.com; form-action 'self' https://www.paypal.com; object-src 'none'; base-uri 'self';">
  <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-6EBHYE2X44"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9237571676231200" crossorigin="anonymous"></script>
  <style>
    body {
      background-image: url('https://hackerfrankone.github.io/FamilyFishing/images/background.png?v=1');
      background-color: #000;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height: 100vh;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    a { color: #00ffff; text-decoration: none; }
    .top-bar {
      text-align: center;
      margin-bottom: 2rem;
      width: 100%;
      display: block;
      margin-top: 1rem;
    }
    .social-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
    }
    .facebook-button img, .youtube-button img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      transition: filter 0.3s ease;
    }
    .facebook-button:hover img, .youtube-button:hover img {
      filter: brightness(150%);
    }
    .discord-button, .archive-button, .tackle-button, .submit-fish-button, .rules-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      text-decoration: none;
      transition: filter 0.3s ease;
    }
    .discord-button { background-color: #5865F2; color: white; }
    .archive-button { background-color: #808080; color: white; }
    .tackle-button { background-color: #006400; color: white; }
    .submit-fish-button { background-color: #FFA500; color: white; }
    .rules-button { background-color: #cc0000; color: white; padding: 0; }
    .discord-button:hover, .archive-button:hover, .tackle-button:hover { filter: brightness(150%); }
    .submit-fish-button:hover { filter: brightness(75%); }
    .rules-button:hover { background-color: #ff0000; }
    .tournament-info {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      margin: 1rem auto 0;
      margin-bottom: 0;
      text-align: center;
    }
    .tournament-info p {
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      text-align: center;
    }
    .tournament-info .main-text {
      font-size: 1.5rem;
      font-weight: bold;
      color: #FFD700;
      white-space: nowrap;
      padding: 0.2rem 0;
    }
    .tournament-info .sub-text {
      font-size: 1rem;
      margin-top: 0.1rem;
      padding: 0.2rem 0;
    }
    .text-wrapper {
      background-color: rgba(0, 0, 0, 0.6);
      padding: 0.5rem;
      border-radius: 4px;
    }
    @media (max-width: 768px) {
      .tournament-info {
        padding: 0.4rem 0.8rem;
      }
      .tournament-info .main-text {
        font-size: 1.2rem;
      }
      .tournament-info .sub-text {
        font-size: 0.9rem;
        margin-top: 0.2rem;
      }
    }
    .countdown {
      font-size: 2rem;
      font-weight: bold;
      max-width: 600px;
      margin: 0.2rem auto;
      text-align: center;
      color: #FFD700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      padding: 0.2rem 0;
    }
    .countdown span {
      background: none;
    }
    .countdown-red {
      color: #ff0000 !important;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }
    .feedback {
      font-size: 0.9rem;
      text-align: center;
      margin-top: 0.5rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }
    .feedback a {
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }
    .paypal-form {
      display: grid;
      justify-items: center;
      gap: 0.3rem;
      margin-top: 0.5rem;
      margin-bottom: 0;
    }
    .leaderboard-container {
      text-align: center;
      margin-top: 0.2rem;
      position: relative;
      overflow: visible;
    }
    .current-leaderboard-title, .current-winner-title {
      color: #FFD700;
      font-weight: bold;
      font-size: 1.5rem;
      font-family: Arial, Helvetica, sans-serif;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      background-color: rgba(0, 0, 0, 0.6);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }
    .current-leaderboard-title {
      margin-top: 0.5rem;
      display: block;
    }
    .current-winner-title {
      margin-top: 0;
      display: inline-block;
      margin-left: auto;
      margin-right: auto;
    }
    .current-leaderboard-title span, .current-winner-title span {
      background: none;
      padding: 0;
      border-radius: 0;
      display: inline;
    }
    .identifier-container {
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1000;
    }
    .identifier-container .month-identifier {
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      margin: 0.2rem 0;
      font-family: Arial, Helvetica, sans-serif;
      font-weight: bold;
      color: #FFFFFF;
      font-size: 1.5rem;
    }
    .angler-sidebar {
      position: fixed;
      top: 3rem;
      left: 1rem;
      padding: 1rem;
      border-radius: 8px;
      max-width: 250px;
      max-height: 500px;
      overflow-y: auto;
      z-index: 1000;
    }
    .angler-sidebar h3 {
      color: yellow;
      font-weight: bold;
      font-family: 'Arial', sans-serif;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      margin: 0 0 0.5rem;
      font-size: 1.2rem;
    }
    .angler-sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .angler-sidebar ul::-webkit-scrollbar {
      width: 8px;
    }
    .angler-sidebar ul::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    }
    .angler-sidebar ul::-webkit-scrollbar-thumb {
      background: yellow;
      border-radius: 4px;
    }
    .angler-sidebar ul::-webkit-scrollbar-thumb:hover {
      background: #FFD140;
    }
    .angler-item {
      cursor: pointer;
      position: relative;
      display: flex;
      flex-direction: column;
      margin-bottom: 0.5rem;
      justify-content: flex-start;
    }
    .angler-name {
      display: block;
      color: yellow;
      font-weight: bold;
      font-family: 'Arial', sans-serif;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      font-size: 1.2rem;
      transition: color 0.3s ease;
    }
    .angler-name:hover {
      color: #FFD140;
    }
    .angler-photos {
      display: none;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .angler-photos.show {
      display: flex;
    }
    .fish-image {
      max-width: 100px;
      height: auto;
      border-radius: 8px;
      border: 2px solid #FFD700;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }
    .winner-fish-gallery {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }
    .winner-fish-gallery .fish-image {
      max-width: 200px;
    }
    .fish-item {
      text-align: center;
    }
    .fish-angler-name {
      color: #FFD700;
      font-weight: bold;
      margin-top: 0.5rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }
    @media (max-width: 768px) {
      .countdown {
        font-size: 1.5rem;
      }
      .identifier-container {
        position: static;
        margin: 1rem auto;
        max-width: 100%;
        text-align: center;
      }
      .angler-sidebar {
        position: static;
        margin: 1rem auto;
        max-width: 100%;
        text-align: center;
      }
      .angler-item {
        justify-content: center;
      }
      .identifier-container .month-identifier {
        font-size: 1.2rem;
        color: #FFFFFF;
      }
      .paypal-form {
        margin-top: 0.3rem;
      }
      .leaderboard-container {
        margin-top: 0.1rem;
      }
      .winner-fish-gallery .fish-image {
        max-width: 150px;
      }
      .angler-photos .fish-image {
        max-width: 80px;
      }
    }
    ins.adsbygoogle {
      display: block;
      margin: 0.5rem auto;
      text-align: center;
      min-height: 90px;
    }
    :root {
      --primary-color: #FFA500;
    }
    .sub-text-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .sub-text-container .sub-text,
    .sub-text-container .feedback {
      margin: 0;
      font-size: 1rem;
    }
    .sub-text-container .sub-text {
      background-color: transparent;
    }
    @media (max-width: 768px) {
      .sub-text-container .sub-text,
      .sub-text-container .feedback {
        font-size: 0.9rem;
      }
    }
    .pp-MQGR2KDA2VZP4 {
      text-align: center;
      border: none;
      border-radius: 0.25rem;
      min-width: 11.625rem;
      padding: 0 2rem;
      height: 2.625rem;
      font-weight: bold;
      background-color: #FFD140;
      color: #000000;
      font-family: "Helvetica Neue", Arial, sans-serif;
      font-size: 1rem;
      line-height: 1.25rem;
      cursor: pointer;
    }
  </style>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-6EBHYE2X44', { 'anonymize_ip': true });

    const monthCodes = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    function mulberry32(seed) {
      return function() {
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      };
    }

    function generateSeededCode(seed) {
      const usedCodes = JSON.parse(localStorage.getItem('usedCodes') || '[]');
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let code;
      const random = mulberry32(seed);
      let attempts = 0;
      const maxAttempts = 100;
      do {
        code = '';
        for (let i = 0; i < 3; i++) {
          code += letters.charAt(Math.floor(random() * letters.length));
        }
        attempts++;
      } while (usedCodes.includes(code) && attempts < maxAttempts);
      if (attempts >= maxAttempts) {
        console.warn("Could not generate unique code after max attempts, falling back to random code.");
        do {
          code = '';
          for (let i = 0; i < 3; i++) {
            code += letters.charAt(Math.floor(Math.random() * letters.length));
          }
        } while (usedCodes.includes(code));
      }
      if (code !== 'AAA') {
        usedCodes.push(code);
        localStorage.setItem('usedCodes', JSON.stringify(usedCodes));
      }
      return code;
    }

    async function fetchCurrentTime() {
      const cachedTime = localStorage.getItem('serverTime');
      const cacheTimestamp = localStorage.getItem('serverTimeTimestamp');
      const cacheAge = cacheTimestamp ? Date.now() - parseInt(cacheTimestamp) : Infinity;
      if (cachedTime && cacheAge < 3600000) return new Date(cachedTime);
      try {
        const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC', { signal: new AbortController().signal, timeout: 5000 });
        const data = await response.json();
        const serverTime = new Date(data.utc_datetime);
        localStorage.setItem('serverTime', serverTime.toISOString());
        localStorage.setItem('serverTimeTimestamp', Date.now().toString());
        return serverTime;
      } catch (error) {
        console.error("Failed to fetch server time, falling back to local time:", error);
        return new Date();
      }
    }

    async function fetchWithRetry(urls, maxRetries = 5, timeout = 15000) {
      for (let url of urls) {
        for (let i = 0; i < maxRetries; i++) {
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(`${url}?cacheBust=${Date.now()}`, {
              signal: controller.signal,
              cache: 'no-cache',
              headers: {
                'Accept': 'text/csv,application/json'
              }
            });
            clearTimeout(timeoutId);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}`);
            }
            console.log(`Successfully fetched ${url}`);
            return response;
          } catch (error) {
            console.error(`Fetch attempt ${i + 1} failed for ${url}: ${error.name} - ${error.message}`);
            if (i === maxRetries - 1) {
              console.warn(`All ${maxRetries} attempts failed for ${url}`);
            } else {
              await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i))); // Exponential backoff
            }
          }
        }
      }
      throw new Error(`All fetch attempts failed for all URLs: ${urls.join(', ')}`);
    }

    async function loadAnglerList() {
      const anglerList = document.getElementById("angler-list");
      if (!anglerList) {
        console.error("Angler list element not found");
        return [];
      }

      try {
        const urls = [
          'https://hackerfrankone.github.io/FamilyFishing/CSV/angler_list.csv',
          'https://raw.githubusercontent.com/hackerfrankone/FamilyFishing/main/CSV/angler_list.csv'
        ];
        console.log(`Attempting to fetch angler list from: ${urls.join(' or ')}`);
        const response = await fetchWithRetry(urls);
        const text = await response.text();
        console.log(`Received CSV content: ${text}`);
        if (!text.trim()) {
          console.warn("CSV is empty");
          anglerList.innerHTML = '<li>No anglers registered</li>';
          return [];
        }
        const rows = text.trim().split('\n').map(row => row.split(',').map(cell => cell.trim()));
        const headers = rows[0];
        if (!headers || headers[0].toLowerCase() !== 'name') {
          console.error(`Invalid CSV format: Expected header "name", got "${headers ? headers[0] : 'undefined'}"`);
          anglerList.innerHTML = '<li>Error loading anglers</li>';
          return [];
        }
        const anglers = rows.slice(1).map(row => ({
          name: row[0] || ''
        })).filter(angler => angler.name);

        console.log(`Parsed ${anglers.length} anglers:`, anglers);
        anglerList.innerHTML = anglers.length > 0
          ? anglers.map(angler => `
            <li class="angler-item" data-angler="${angler.name}">
              <span class="angler-name">${angler.name}</span>
              <div class="angler-photos" id="photos-${angler.name.replace(/\s+/g, '-')}" data-angler="${angler.name}"></div>
            </li>
          `).join('')
          : '<li>No anglers registered</li>';

        // Add click listeners for toggling photos
        document.querySelectorAll('.angler-name').forEach(nameElement => {
          nameElement.addEventListener('click', () => {
            const photosDiv = nameElement.parentElement.querySelector('.angler-photos');
            photosDiv.classList.toggle('show');
          });
        });

        return anglers.map(angler => angler.name);
      } catch (error) {
        console.error('Error loading angler list from CSV:', error.message);
        anglerList.innerHTML = '<li>Failed to load anglers</li>';
        return [];
      }
    }

    function normalizeName(name) {
      return name
        .replace(/[-_]/g, ' ') // Replace underscores and dashes with spaces
        .replace(/\s+/g, ' ') // Collapse multiple spaces
        .replace(/[-_\d+].*$/, '') // Remove suffixes (e.g., _fish1, -2025)
        .trim()
        .toLowerCase();
    }

    async function loadFishGallery() {
      const gallery = document.getElementById("winner-fish-gallery");
      if (!gallery) {
        console.error("Fish gallery element not found");
        return;
      }

      try {
        // Fetch angler names from CSV
        const anglerNames = await loadAnglerList();
        if (!anglerNames.length) {
          console.warn("No anglers in CSV, skipping fish gallery load");
          gallery.innerHTML = '<p>No registered anglers</p>';
          return;
        }
        const normalizedAnglerNames = anglerNames.map(normalizeName);
        console.log(`Normalized angler names:`, normalizedAnglerNames);

        // Fetch Dropbox file metadata from backend proxy
        const backendUrl = 'https://your-backend.vercel.app/api/dropbox-files';
        console.log(`Fetching Dropbox files from: ${backendUrl}`);
        const response = await fetchWithRetry([backendUrl]);
        const files = await response.json();
        console.log(`Received Dropbox files:`, files.map(f => f.name));

        // Group files by angler
        const anglerPhotos = {};
        anglerNames.forEach(name => anglerPhotos[name] = []);

        files
          .filter(file => file['.tag'] === 'file' && /\.(jpg|jpeg|png|heic|webp)$/i.test(file.name))
          .forEach(file => {
            // Extract angler name from filename (e.g., "Frank_Ellison_fish1.jpg" -> "Frank Ellison")
            const match = file.name.match(/^(.+?)(?:[-_\d+].*|\.\w+)$/); // Match until suffix or extension
            const anglerName = match ? match[1].replace(/[-_]/g, ' ') : '';
            const normalizedName = normalizeName(anglerName);
            console.log(`Processing file: ${file.name}, extracted name: ${anglerName}, normalized: ${normalizedName}`);
            const matchedAngler = anglerNames.find(name => normalizeName(name) === normalizedName);
            if (matchedAngler && anglerPhotos[matchedAngler].length < 5) {
              anglerPhotos[matchedAngler].push({
                imageUrl: file.sharedLink.replace('?dl=0', '?raw=1'),
                fileName: file.name
              });
            }
          });

        console.log(`Grouped photos by angler:`, anglerPhotos);

        // Update angler sidebar photos
        anglerNames.forEach(name => {
          const photosDiv = document.getElementById(`photos-${name.replace(/\s+/g, '-')}`);
          if (photosDiv) {
            photosDiv.innerHTML = anglerPhotos[name].length > 0
              ? anglerPhotos[name].map(photo => `
                <img src="${photo.imageUrl}" alt="Fish by ${name}" class="fish-image" onerror="this.parentElement.innerHTML='<p>Failed to load image: ${photo.fileName}</p>'">
              `).join('')
              : '<p>No photos</p>';
          }
        });

        // Update main gallery
        const allPhotos = Object.entries(anglerPhotos).flatMap(([name, photos]) =>
          photos.map(photo => ({ anglerName: name, imageUrl: photo.imageUrl }))
        );
        gallery.innerHTML = allPhotos.length > 0
          ? allPhotos.map(item => `
            <div class="fish-item">
              <img src="${item.imageUrl}" alt="Fish by ${item.anglerName}" class="fish-image" onerror="this.parentElement.innerHTML='<p>Failed to load image for ${item.anglerName}</p>'">
              <p class="fish-angler-name">${item.anglerName}</p>
            </div>
          `).join('')
          : '<p>No fish images from registered anglers</p>';
      } catch (error) {
        console.error('Error loading fish gallery:', error.message);
        gallery.innerHTML = '<p>Failed to load fish images</p>';
      }
    }

    async function checkAndArchivePreviousWinner(today, monthNumber, year) {
      const lastMonthDate = new Date(year, monthNumber - 1, 1);
      const lastMonthCode = monthCodes[lastMonthDate.getMonth()];
      const lastMonthYear = lastMonthDate.getFullYear();
      const lastMonth = `${lastMonthCode} ${lastMonthYear}`;
      const currentWinnerData = JSON.parse(localStorage.getItem('currentWinner') || '{}');
      const storedMonthYear = localStorage.getItem('monthYear');
      if (storedMonthYear !== `${year}-${monthNumber}` && currentWinnerData.month === lastMonth) {
        const winner = currentWinnerData.angler;
        const totalInches = currentWinnerData.totalInches;
        const fishList = currentWinnerData.fishList || [];
        let archiveData = [];
        try {
          const response = await fetchWithRetry(['https://raw.githubusercontent.com/hackerfrankone/FamilyFishing/main/images/archive/archive.json']);
          if (response.ok) archiveData = await response.json();
        } catch (error) {
          console.error("Failed to fetch archive data:", error);
        }
        if (!archiveData.find(item => item.month === lastMonth)) {
          archiveData.push({
            month: lastMonth,
            angler: winner,
            totalInches: totalInches,
            fishList: fishList
          });
          const newArchiveContent = JSON.stringify(archiveData, null, 2);
          console.log(`Update archive.json with: ${newArchiveContent}`);
        }
      }
    }

    let isUpdatingMonth = false;
    async function updateMonth() {
      if (isUpdatingMonth) return;
      isUpdatingMonth = true;
      try {
        const today = await fetchCurrentTime();
        const monthNumber = today.getMonth();
        const year = today.getFullYear();
        const monthCode = monthCodes[monthNumber];
        const currentMonthYear = `${year}-${monthNumber}`;
        let storedMonthCode = localStorage.getItem('monthCode');
        if (localStorage.getItem('monthYear') !== currentMonthYear || !storedMonthCode) {
          localStorage.setItem('monthYear', currentMonthYear);
          localStorage.setItem('usedCodes', JSON.stringify([]));
          storedMonthCode = generateSeededCode(parseInt(`${year}${monthNumber.toString().padStart(2, '0')}`));
          localStorage.setItem('monthCode', storedMonthCode);
          await checkAndArchivePreviousWinner(today, monthNumber, year);
        }
        const monthElement = document.getElementById("month");
        const monthCodeElement = document.getElementById("month-code");
        const biggestBassTitleElement = document.getElementById("biggest-bass-title");
        const currentWinnerElement = document.getElementById("current-winner-name");
        if (monthElement) monthElement.textContent = monthCode;
        if (monthCodeElement) monthCodeElement.textContent = storedMonthCode;
        if (biggestBassTitleElement) biggestBassTitleElement.textContent = `${monthCode}'s Biggest Bass`;
        if (currentWinnerElement) currentWinnerElement.textContent = `Waiting on angler to submit fish`;
      } catch (error) {
        console.error("Error updating month:", error.message, error.stack);
      } finally {
        isUpdatingMonth = false;
      }
    }

    let serverTimeOffset = 0;
    let countdownInterval = null;
    async function initializeCountdown() {
      try {
        const serverTime = await fetchCurrentTime();
        serverTimeOffset = serverTime.getTime() - Date.now();
        updateCountdown();
      } catch (error) {
        console.error("Error fetching server time:", error);
        updateCountdown();
      }
    }

    function updateCountdown() {
      const timerElement = document.getElementById("countdown-timer");
      const countdownElement = document.getElementById("countdown");
      if (!timerElement || !countdownElement) return;

      const now = new Date(Date.now() + serverTimeOffset);
      const year = now.getFullYear();
      const month = now.getMonth();
      const target = new Date(Date.UTC(year, month + 1, 1, 0, 0, 0));
      const timeDiff = target - now;

      if (timeDiff <= 0) {
        updateMonth();
        timerElement.textContent = "Tournament ended!";
        countdownElement.classList.remove('countdown-red');
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
        return;
      }

      const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
      timerElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
      if (days <= 7) countdownElement.classList.add('countdown-red');
      else countdownElement.classList.remove('countdown-red');
    }

    function startCountdown() {
      if (countdownInterval) clearInterval(countdownInterval);
      countdownInterval = setInterval(updateCountdown, 2000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.dataLayer.push({event: 'pageview'});
      updateMonth();
      initializeCountdown();
      startCountdown();
      loadAnglerList();
      loadFishGallery();
      setInterval(() => {
        loadAnglerList();
        loadFishGallery();
      }, 30000); // Poll every 30 seconds
      (adsbygoogle = window.adsbygoogle || []).push({});
    });
  </script>
</head>
<body>
  <div class="identifier-container">
    <p id="monthly-identifier" class="month-identifier"><span id="month"></span> Identifier: <span id="month-code"></span></p>
  </div>
  <div class="angler-sidebar">
    <h3>ANGLERS:</h3>
    <ul id="angler-list"><li>Loading...</li></ul>
  </div>
  <div class="top-bar">
    <div class="social-buttons">
      <a href="pages/tackle.html" target="_blank" rel="noopener noreferrer" class="tackle-button" aria-label="Visit our Tackle" tabindex="0" onclick="alert('Coming soon'); return false;">Tackle</a>
      <a href="https://www.facebook.com/share/g/18orZuMkch/" target="_blank" rel="noopener noreferrer" class="facebook-button" aria-label="Visit our Facebook page" tabindex="0">
        <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook logo" width="60" height="60">
      </a>
      <a href="https://www.youtube.com/@usafamilyfishingfun" target="_blank" rel="noopener noreferrer" class="youtube-button" aria-label="Visit our YouTube channel" tabindex="0">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/YouTube_Logo_2017.svg" alt="YouTube logo">
      </a>
      <a href="https://discord.gg/SWxsq4q8wH" target="_blank" rel="noopener noreferrer" class="discord-button" aria-label="Join our Discord server" tabindex="0">Discord</a>
      <a href="pages/archive.html" target="_blank" rel="noopener noreferrer" class="archive-button" aria-label="View our archive" tabindex="0">Archive</a>
      <a href="https://www.dropbox.com/request/YwG0NvsfxiLX9Ciiypcy" target="_blank" rel="noopener noreferrer" class="submit-fish-button" aria-label="Submit Fish" tabindex="0">Submit Fish</a>
      <a href="PDFs/rules.pdf?v=2" target="_blank" rel="noopener" class="rules-button" aria-label="View Rules" tabindex="0">ðŸ“„ Rules</a>
    </div>
    <div class="tournament-info">
      <div class="text-wrapper">
        <p class="main-text">1st Place: 100% Payout</p>
        <p class="main-text">Month long | 5 Bass limit | More anglers = More payout</p>
        <div class="sub-text-container">
          <p class="sub-text">Tennessee Lakes Only | </p>
          <p class="feedback">Feedback or questions: <a href="mailto:usa@familyfishing.fun" rel="noopener">usa@familyfishing.fun</a></p>
        </div>
        <p class="countdown" id="countdown"><span>Tournament ends in: </span><span id="countdown-timer">Calculating...</span></p>
      </div>
      <div class="paypal-form">
        <form action="https://www.paypal.com/ncp/payment/MQGR2KDA2VZP4" method="post" target="_blank" style="display:inline-grid;justify-items:center;align-content:start;gap:0.5rem;">
          <input type="hidden" name="amount" value="25.00">
          <input class="pp-MQGR2KDA2VZP4" type="submit" value="Join Tournament $25" />
        </form>
      </div>
    </div>
  </div>
  <div class="leaderboard-container">
    <div class="current-winner-title"><span><strong id="current-winner-name">Waiting on angler to submit fish</strong></span></div>
    <div id="winner-fish-gallery" class="winner-fish-gallery"></div>
  </div>
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9237571676231200" data-ad-slot="auto" data-ad-format="auto" data-full-width-responsive="true"></ins>
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9237571676231200" data-ad-slot="auto" data-ad-format="auto" data-full-width-responsive="true"></ins>
</body>
</html>
