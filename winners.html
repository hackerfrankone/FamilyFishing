<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FFF Winners - Family Fishing Fun</title>
  <base href="https://www.familyfishing.fun/">
  <link rel="icon" type="image/x-icon" href="https://www.familyfishing.fun/images/favicon.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https://www.familyfishing.fun https://*.cloudflare.com data:; connect-src 'self' https://www.familyfishing.fun https://fish-angler.familyfishingfun2025.workers.dev https://worldtimeapi.org http://worldtimeapi.org; form-action 'self'; object-src 'none'; base-uri 'self';">
  <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <style>
    body {
      background-image: url('https://www.familyfishing.fun/images/background.png?v=2');
      background-color: #000;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height: 100vh;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #FFD700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    .back-button {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background-color: #28a745;
      color: #fff;
      font-weight: bold;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      text-decoration: none;
      transition: filter 0.3s ease;
      z-index: 1000;
    }
    .back-button:hover {
      filter: brightness(120%);
    }
    .winners-container {
      background: rgba(0, 0, 0, 0.7);
      padding: 1.5rem;
      border-radius: 8px;
      width: 100%;
      max-width: 800px;
      margin-top: 3rem;
    }
    .year-section {
      margin-bottom: 2rem;
    }
    .year-section h2 {
      color: #FFD700;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    select {
      width: 100%;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    .winners-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .winner-item {
      padding: 0.5rem;
      border-bottom: 1px solid #FFD700;
    }
    .winner-header {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .winner-rank {
      color: #FF4500;
      font-size: 1.2rem;
      font-weight: bold;
      margin-right: 1rem;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    .winner-name {
      color: #FFD700;
      font-size: 1.2rem;
      font-weight: bold;
      flex: 1;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    .winner-total {
      color: #FFD700;
      font-size: 1.2rem;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    .fish-list {
      list-style: none;
      padding: 0.5rem;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid #FFD700;
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 0.75rem;
      overflow-x: auto;
      white-space: nowrap;
      margin-top: 0.5rem;
    }
    .fish-item {
      margin-bottom: 0;
      flex: 0 0 auto;
    }
    .fish-length {
      color: #FFD700;
      font-size: 1rem;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    .fish-length:hover {
      color: #ffeb3b;
    }
    .error-message, .placeholder-message {
      color: #ff0000;
      font-size: 1rem;
      text-align: center;
      margin-top: 1rem;
    }
    @media (max-width: 768px) {
      h1 { font-size: 2rem; }
      .winners-container { padding: 1rem; max-width: 95%; }
      .year-section h2 { font-size: 1.5rem; }
      .winner-rank, .winner-name, .winner-total { font-size: 1rem; }
      .fish-length { font-size: 0.9rem; }
      .back-button { padding: 0.4rem 0.8rem; font-size: 0.9rem; }
      select { font-size: 0.9rem; }
    }
  </style>
  <script>
    const monthCodes = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    async function fetchCurrentTime() {
      const endpoints = [
        'https://worldtimeapi.org/api/timezone/Etc/UTC',
        'http://worldtimeapi.org/api/timezone/Etc/UTC'
      ];
      let lastError = null;

      for (let attempt = 1; attempt <= 3; attempt++) {
        for (const endpoint of endpoints) {
          try {
            const response = await fetch(endpoint, {
              cache: 'no-cache',
              headers: { 'Accept': 'application/json' }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status} from ${endpoint}`);
            const data = await response.json();
            return new Date(data.utc_datetime);
          } catch (error) {
            lastError = error;
            console.error(`Attempt ${attempt} failed for ${endpoint}: ${error.message}`);
          }
        }
        // Wait 1 second before retrying
        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      console.error('All attempts to fetch server time failed, falling back to local time:', lastError.message);
      return new Date();
    }

    async function fetchAnglerList() {
      try {
        const response = await fetch('https://fish-angler.familyfishingfun2025.workers.dev/angler_list', {
          cache: 'no-cache',
          headers: { 'Accept': 'application/json' }
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const anglers = await response.json();
        if (!Array.isArray(anglers)) throw new Error('Invalid angler list format');
        return anglers.map(name => name.replace(/[<>]/g, '')).filter(name => name.length > 0);
      } catch (error) {
        console.error('Failed to fetch anglers:', error.message);
        return [];
      }
    }

    async function fetchFishForAngler(anglerName) {
      try {
        const response = await fetch(`https://fish-angler.familyfishingfun2025.workers.dev/fish_list?angler=${encodeURIComponent(anglerName)}`, {
          cache: 'no-cache',
          headers: { 'Accept': 'application/json' }
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
      } catch (error) {
        console.error(`Failed to fetch fish for ${anglerName}:`, error.message);
        return [];
      }
    }

    async function saveWinners(year, month) {
      try {
        console.log(`Saving winners for ${monthCodes[month - 1]} ${year}`);
        const anglers = await fetchAnglerList();
        const anglerData = [];
        for (const name of anglers) {
          const fish = await fetchFishForAngler(name);
          const totalLength = fish.reduce((sum, f) => sum + parseFloat(f.length || 0), 0);
          anglerData.push({ name, fish, totalLength });
        }
        anglerData.sort((a, b) => b.totalLength - a.totalLength);
        const rankedAnglers = anglerData.map((angler, index) => ({
          name: angler.name,
          fish: angler.fish,
          totalLength: angler.totalLength,
          rank: index + 1
        }));

        // Save to server
        const response = await fetch('https://fish-angler.familyfishingfun2025.workers.dev/save_winners', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ year, month, winners: rankedAnglers })
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        // Update UI
        const winnersList = document.getElementById(`winners-${year}-${month}`);
        if (!winnersList) return;
        winnersList.innerHTML = rankedAnglers.length > 0
          ? rankedAnglers.map(angler => `
              <li class="winner-item">
                <div class="winner-header">
                  <span class="winner-rank">${angler.rank}${angler.rank === 1 ? 'st' : angler.rank === 2 ? 'nd' : angler.rank === 3 ? 'rd' : 'th'}</span>
                  <span class="winner-name">${angler.name}</span>
                  <span class="winner-total">${angler.totalLength.toFixed(2)}"</span>
                </div>
                <ul class="fish-list">
                  ${angler.fish.length > 0
                    ? angler.fish.map(f => `
                        <li class="fish-item">
                          <a class="fish-length" href="${f.image_url}" target="_blank" rel="noopener">${Number(f.length).toFixed(2)}"</a>
                        </li>
                      `).join('')
                    : '<li class="fish-item">No fish submitted</li>'
                  }
                </ul>
              </li>
            `).join('')
          : '<li class="winner-item">No winners recorded</li>';
      } catch (error) {
        console.error(`Failed to save winners for ${monthCodes[month - 1]} ${year}:`, error.message);
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = `Failed to save winners for ${monthCodes[month - 1]} ${year}. Please try again later.`;
        errorMessage.style.display = 'block';
      }
    }

    async function loadWinners() {
      const winnersContainer = document.getElementById('winnersContainer');
      if (!winnersContainer) return;

      const now = await fetchCurrentTime();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;

      // Determine if 2025 is complete (after Dec 31, 2025)
      const is2025Complete = year > 2025 || (year === 2025 && month > 12);

      // Start with August 2025
      const startYear = 2025;
      for (let y = startYear; y <= year; y++) {
        const section = document.createElement('div');
        section.className = 'year-section';
        let months = [];
        let startMonth = (y === 2025) ? 8 : 1;
        let endMonth = (y === year) ? month : 12;

        if (y === 2025 && is2025Complete) {
          // Group 2025 months into a dropdown
          months = Array.from({ length: 12 - startMonth + 1 }, (_, i) => i + startMonth);
          section.innerHTML = `
            <h2>2025 Monthly Winners</h2>
            <select id="year-2025" onchange="showMonthWinners(2025, this.value)">
              <option value="">Select a month</option>
              ${months.map(m => `<option value="${m}">${monthCodes[m - 1]}</option>`).join('')}
            </select>
            <div id="winners-2025"></div>
          `;
          winnersContainer.appendChild(section);

          // Load winners for selected 2025 month
          const select = section.querySelector('select');
          select.addEventListener('change', async () => {
            const month = parseInt(select.value);
            if (!month) {
              document.getElementById('winners-2025').innerHTML = '';
              return;
            }
            try {
              const response = await fetch(`https://fish-angler.familyfishingfun2025.workers.dev/winners?year=2025&month=${month}`, {
                cache: 'no-cache',
                headers: { 'Accept': 'application/json' }
              });
              if (!response.ok) throw new Error(`HTTP ${response.status}`);
              const rankedAnglers = await response.json();
              const winnersDiv = document.getElementById('winners-2025');
              winnersDiv.innerHTML = `
                <ul class="winners-list" id="winners-2025-${month}">
                  ${rankedAnglers.length > 0
                    ? rankedAnglers.map(angler => `
                        <li class="winner-item">
                          <div class="winner-header">
                            <span class="winner-rank">${angler.rank}${angler.rank === 1 ? 'st' : angler.rank === 2 ? 'nd' : angler.rank === 3 ? 'rd' : 'th'}</span>
                            <span class="winner-name">${angler.name}</span>
                            <span class="winner-total">${angler.totalLength.toFixed(2)}"</span>
                          </div>
                          <ul class="fish-list">
                            ${angler.fish.length > 0
                              ? angler.fish.map(f => `
                                  <li class="fish-item">
                                    <a class="fish-length" href="${f.image_url}" target="_blank" rel="noopener">${Number(f.length).toFixed(2)}"</a>
                                  </li>
                                `).join('')
                              : '<li class="fish-item">No fish submitted</li>'
                            }
                          </ul>
                        </li>
                      `).join('')
                    : '<li class="winner-item">No winners recorded</li>'
                  }
                </ul>
              `;
            } catch (error) {
              console.error(`Failed to load winners for ${monthCodes[month - 1]} 2025:`, error.message);
              document.getElementById('winners-2025').innerHTML = '<p class="placeholder-message">No winners recorded for this month.</p>';
            }
          });
        } else {
          // Display individual months for incomplete years
          for (let m = startMonth; m <= endMonth; m++) {
            const monthSection = document.createElement('div');
            monthSection.className = 'year-section';
            monthSection.innerHTML = `
              <h2>${monthCodes[m - 1]} ${y}</h2>
              <ul class="winners-list" id="winners-${y}-${m}"></ul>
            `;
            winnersContainer.appendChild(monthSection);

            // Check if tournament has ended
            const target = new Date(Date.UTC(y, m, 1, 0, 0, 0));
            if (now < target && y === year && m === month) {
              const winnersList = document.getElementById(`winners-${y}-${m}`);
              winnersList.innerHTML = '<p class="placeholder-message">Tournament ongoing, winners will be announced after the tournament ends.</p>';
              continue;
            }

            // Load winners from server
            try {
              const response = await fetch(`https://fish-angler.familyfishingfun2025.workers.dev/winners?year=${y}&month=${m}`, {
                cache: 'no-cache',
                headers: { 'Accept': 'application/json' }
              });
              if (!response.ok) throw new Error(`HTTP ${response.status}`);
              const rankedAnglers = await response.json();
              const winnersList = document.getElementById(`winners-${y}-${m}`);
              winnersList.innerHTML = rankedAnglers.length > 0
                ? rankedAnglers.map(angler => `
                    <li class="winner-item">
                      <div class="winner-header">
                        <span class="winner-rank">${angler.rank}${angler.rank === 1 ? 'st' : angler.rank === 2 ? 'nd' : angler.rank === 3 ? 'rd' : 'th'}</span>
                        <span class="winner-name">${angler.name}</span>
                        <span class="winner-total">${angler.totalLength.toFixed(2)}"</span>
                      </div>
                      <ul class="fish-list">
                        ${angler.fish.length > 0
                          ? angler.fish.map(f => `
                              <li class="fish-item">
                                <a class="fish-length" href="${f.image_url}" target="_blank" rel="noopener">${Number(f.length).toFixed(2)}"</a>
                              </li>
                            `).join('')
                          : '<li class="fish-item">No fish submitted</li>'
                        }
                      </ul>
                    </li>
                  `).join('')
                : '<li class="winner-item">No winners recorded</li>';
            } catch (error) {
              console.error(`Failed to load winners for ${monthCodes[m - 1]} ${y}:`, error.message);
              const winnersList = document.getElementById(`winners-${y}-${m}`);
              winnersList.innerHTML = '<p class="placeholder-message">No winners recorded for this month.</p>';
            }
          }
        }
      }

      // Save winners for current month if tournament has ended
      const target = new Date(Date.UTC(year, month, 1, 0, 0, 0));
      if (now >= target && year >= 2025 && month >= 8) {
        await saveWinners(year, month);
      }
    }

    async function initTournamentListener() {
      const now = await fetchCurrentTime();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const target = new Date(Date.UTC(year, month, 1, 0, 0, 0));

      const checkTournamentEnd = async () => {
        const currentTime = await fetchCurrentTime();
        if (currentTime >= target && year >= 2025 && month >= 8) {
          await saveWinners(year, month);
          document.getElementById('winnersContainer').innerHTML = '';
          await loadWinners();
          clearInterval(interval);
        }
      };

      const interval = setInterval(checkTournamentEnd, 86400000); // Check every 24 hours
      await checkTournamentEnd();
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadWinners();
      initTournamentListener();
    });
  </script>
</head>
<body>
  <a href="index.html" class="back-button">Back to Home</a>
  <h1>Monthly Winners</h1>
  <div class="winners-container" id="winnersContainer"></div>
  <p id="errorMessage" class="error-message" style="display: none;"></p>
</body>
</html>
