addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request));
});

async function handleRequest(request) {
  const url = new URL(request.url);
  const path = url.pathname;

  if (path === '/submit' && request.method === 'POST') {
    return handleSubmit(request);
  } else if (path === '/' && request.method === 'GET') {
    return handleGetAnglers();
  } else if (path === '/images' && request.method === 'GET') {
    return handleGetImages(url.searchParams);
  } else {
    return new Response(JSON.stringify({ error: 'Method Not Allowed' }), {
      status: 405,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}

async function handleSubmit(request) {
  try {
    if (request.headers.get('Content-Type') !== 'application/json') {
      return new Response(JSON.stringify({ error: 'Expected application/json content type' }), {
        status: 415,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    const payload = await request.json();
    const { angler, image, length } = payload;

    if (!angler || !image || !length) {
      return new Response(JSON.stringify({ error: 'Missing required fields' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // Validate angler against angler_list.csv
    const anglers = await fetchAnglerList();
    if (!anglers.includes(angler)) {
      return new Response(JSON.stringify({ error: 'Angler not registered' }), {
        status: 403,
        headers: { 'Content-Type': 'application/json' }
      });
    }

    // Decode base64 image
    const matches = image.match(/^data:image\/(\w+);base64,(.+)$/);
    if (!matches) {
      return new Response(JSON.stringify({ error: 'Invalid image format' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' }
      });
    }
    const [, imageType, base64Data] = matches;
    const imageBuffer = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));

    // Upload to Cloudflare Images
    const accountId = 'YOUR_CLOUDFLARE_ACCOUNT_ID'; // Replace with your account ID
    const apiToken = 'YOUR_CLOUDFLARE_API_TOKEN'; // Replace with your API token
    const uploadUrl = `https://api.cloudflare.com/client/v4/accounts/${accountId}/images/v1`;
    const formData = new FormData();
    formData.append('file', new Blob([imageBuffer], { type: `image/${imageType}` }), `fish-${angler}-${Date.now()}.${imageType}`);

    const uploadResponse = await fetch(uploadUrl, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiToken}`
      },
      body: formData
    });

    if (!uploadResponse.ok) {
      const errorText = await uploadResponse.text();
      throw new Error(`Cloudflare Images upload failed: ${uploadResponse.status} - ${errorText}`);
    }

    const uploadResult = await uploadResponse.json();
    const imageUrl = uploadResult.result.variants[0];

    // Store image metadata in KV
    await KV.put(`image:${angler}:${Date.now()}`, JSON.stringify({ url: imageUrl, length }));

    return new Response(JSON.stringify({ imageUrl, message: 'Fish submitted successfully' }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}

async function fetchAnglerList() {
  try {
    // Replace with your Dropbox CSV link or another source if applicable
    const response = await fetch('YOUR_DROPBOX_CSV_SHARED_LINK?raw=1', { cache: 'no-cache' });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const text = await response.text();
    if (!text.trim()) throw new Error('Empty CSV');
    return text.trim().split('\n').slice(1).map(row => row.split(',')[0].trim()).filter(name => name);
  } catch (error) {
    console.error('Failed to fetch angler list:', error.message);
    return [];
  }
}

async function handleGetAnglers() {
  const anglers = await fetchAnglerList();
  return new Response(JSON.stringify({ anglers }), {
    status: 200,
    headers: { 'Content-Type': 'application/json' }
  });
}

async function handleGetImages(params) {
  const angler = params.get('name');
  if (!angler) {
    return new Response(JSON.stringify({ error: 'Angler name required' }), {
      status: 400,
      headers: { 'Content-Type': 'application/json' }
    });
  }

  try {
    const keys = await KV.list({ prefix: `image:${angler}:` });
    const images = [];
    for (const key of keys.keys) {
      const data = await KV.get(key.name);
      if (data) {
        const { url, length } = JSON.parse(data);
        images.push({ url, length });
      }
    }
    return new Response(JSON.stringify({ images }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}
