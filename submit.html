<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Submit Fish - Family Fishing Fun</title>
  <base href="https://hackerfrankone.github.io/FamilyFishing/">
  <link rel="icon" type="image/png" href="https://hackerfrankone.github.io/FamilyFishing/images/app.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' https://hackerfrankone.github.io https://www.familyfishing.fun https://*.cloudflare.com data:; connect-src 'self' https://hackerfrankone.github.io https://www.familyfishing.fun https://fish-angler.familyfishingfun2025.workers.dev; form-action 'self'; object-src 'none'; base-uri 'self';">
  <script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/exifr.min.js"></script>
  <style>
    body { background-image: url('https://hackerfrankone.github.io/FamilyFishing/images/background.png?v=2'); background-color: #000; background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; min-height: 100vh; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
    h1 { color: #FFD700; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); text-align: center; }
    .submit-form { background: rgba(0, 0, 0, 0.6); padding: 1rem; border-radius: 8px; width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 1rem; }
    label { font-weight: bold; color: #FFD700; }
    select, input[type="file"], input[type="number"], input[type="password"] { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; background: #fff; color: #000; font-size: 1rem; }
    input[type="submit"] { background-color: #28a745; color: #fff; font-weight: bold; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer; transition: filter 0.3s ease; }
    input[type="submit"]:disabled { background-color: #218838; cursor: not-allowed; filter: brightness(80%); }
    input[type="submit"]:hover:not(:disabled) { filter: brightness(120%); }
    .fish-entry { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem; }
    .add-fish-button { background-color: #0066cc; color: #fff; font-weight: bold; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; align-self: flex-end; font-size: 0.8rem; }
    .success-message, .error-message, .loading-message { font-size: 0.9rem; text-align: center; display: none; }
    .success-message { color: #28a745; }
    .loading-message { color: #FFD700; font-weight: bold; }
    .error-message { color: #ff0000; }
  </style>
  <script>
    async function checkFirstSubmission(angler) {
      // call worker API to see if angler already has a PIN
      try {
        const res = await fetch(`https://fish-angler.familyfishingfun2025.workers.dev/check_pin?name=${encodeURIComponent(angler)}`);
        const data = await res.json();
        return data.hasPin; // true if PIN exists
      } catch (e) {
        console.error("PIN check failed:", e);
        return true; // safe fallback: assume PIN exists
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      populateAnglerDropdown();
      document.getElementById('fishForm').addEventListener('submit', handleSubmit);
      document.querySelector('.add-fish-button').addEventListener('click', addFishEntry);

      document.getElementById('anglerName').addEventListener('change', async () => {
        const angler = document.getElementById('anglerName').value;
        if (angler) {
          const hasPin = await checkFirstSubmission(angler);
          const pinLabel = document.getElementById('pinLabel');
          pinLabel.textContent = hasPin ? "Enter Your 6-Digit PIN:" : "Set a New 6-Digit PIN:";
          document.getElementById('pin').value = "";
        }
      });
    });
  </script>
</head>
<body>
  <h1>Submit Your Fish</h1>
  <form id="fishForm" class="submit-form" action="https://fish-angler.familyfishingfun2025.workers.dev/submit_fish" method="POST" enctype="multipart/form-data">
    <label for="anglerName">Angler Name:</label>
    <select id="anglerName" name="name" required><option value="">Loading anglers...</option></select>

    <label id="pinLabel" for="pin">6-Digit PIN:</label>
    <input type="password" id="pin" name="pin" minlength="6" maxlength="6" required>

    <div id="fishEntry1" class="fish-entry">
      <label for="fishPhoto1">Fish Photo:</label>
      <input type="file" id="fishPhoto1" name="fishPhoto1" accept="image/*" required>
      <label for="fishLength1">Fish Length (inches):</label>
      <input type="number" id="fishLength1" name="fishLength1" step="0.25" min="0" placeholder="example: 12.75" required>
    </div>

    <input type="submit" id="submitButton" value="Submit Fish" disabled>
    <button type="button" class="add-fish-button">Submit More Fish</button>

    <p id="successMessage" class="success-message"></p>
    <p id="errorMessage" class="error-message"></p>
    <p id="loadingMessage" class="loading-message">Please do not close, uploading picture...</p>
  </form>
</body>
</html>
