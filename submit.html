<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Submit Fish - Family Fishing Fun</title>
  <base href="https://hackerfrankone.github.io/FamilyFishing/">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https://hackerfrankone.github.io https://www.familyfishing.fun https://*.cloudflare.com data:; connect-src 'self' https://hackerfrankone.github.io https://www.familyfishing.fun https://fish-angler.familyfishingfun2025.workers.dev; form-action 'self'; object-src 'none'; base-uri 'self';">
  <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <style>
    body { background-image: url('https://hackerfrankone.github.io/FamilyFishing/images/background.png?v=2'); background-color: #000; background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; min-height: 100vh; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
    h1 { color: #FFD700; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); text-align: center; }
    .submit-form { background: rgba(0, 0, 0, 0.6); padding: 1rem; border-radius: 8px; width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 1rem; }
    label { font-weight: bold; color: #FFD700; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); }
    select, input[type="file"], input[type="number"] { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; background: #fff; color: #000; font-size: 1rem; }
    select:disabled { background: #666; cursor: not-allowed; }
    input[type="submit"] { background-color: #28a745; color: #fff; font-weight: bold; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer; transition: filter 0.3s ease; }
    input[type="submit"]:disabled { background-color: #218838; cursor: not-allowed; filter: brightness(80%); }
    input[type="submit"]:hover:not(:disabled) { filter: brightness(120%); }
    .fish-entry { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem; }
    .success-message, .error-message, .loading-message { font-size: 0.9rem; text-align: center; display: none; }
    .success-message { color: #28a745; }
    .loading-message { color: #FFD700; font-weight: bold; }
    .error-message { color: #ff0000; }
    .preview-image { max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 4px; margin-top: 0.5rem; }
    @media (max-width: 768px) { .submit-form { padding: 0.5rem; } h1 { font-size: 1.5rem; } select, input[type="file"], input[type="number"], input[type="submit"] { font-size: 0.9rem; } .preview-image { max-width: 80px; max-height: 80px; } }
  </style>
  <script>
    async function resizeImage(file, maxDimension = 1920, quality = 0.8) {
      if (file.size < 1024 * 1024) {
        console.log(`Skipping resize for ${file.name}: size ${file.size} < 1MB`);
        return file;
      }
      return new Promise((resolve, reject) => {
        console.log(`Resizing ${file.name}, size: ${file.size}, type: ${file.type}`);
        const img = new Image();
        const reader = new FileReader();
        reader.onload = (e) => {
          img.src = e.target.result;
          img.onload = () => {
            try {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              if (width > height) { if (width > maxDimension) { height = Math.round((height * maxDimension) / width); width = maxDimension; } }
              else { if (height > maxDimension) { width = Math.round((width * maxDimension) / height); height = maxDimension; } }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              canvas.toBlob((blob) => {
                console.log(`Resized ${file.name} to ${blob.size} bytes`);
                resolve(new File([blob], file.name.replace(/\.[^/.]+$/, '.jpg'), { type: 'image/jpeg', lastModified: Date.now() }));
              }, 'image/jpeg', quality);
            } catch (err) {
              console.error(`Resize error for ${file.name}: ${err.message}`);
              reject(new Error(`Failed to resize image: ${err.message}`));
            }
          };
          img.onerror = () => reject(new Error('Failed to load image'));
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    function validateFile(file) {
      const validTypes = ['image/jpeg', 'image/png', 'image/heic', 'image/heif', 'image/bmp', 'image/webp', 'image/gif'];
      const maxSize = 10 * 1024 * 1024; // 10MB
      console.log(`Validating ${file.name}: Type=${file.type}, Size=${file.size}`);
      if (!validTypes.includes(file.type)) return `Unsupported image format: ${file.type}. Please use JPEG, PNG, or HEIC.`;
      if (file.size > maxSize) return 'File size exceeds 10MB limit.';
      return null;
    }

    function displayPreview(file, previewId) {
      console.log(`Displaying preview for ${file.name}`);
      try {
        const preview = document.getElementById(previewId);
        const reader = new FileReader();
        reader.onload = (e) => { 
          preview.src = e.target.result; 
          preview.style.display = 'block'; 
          console.log(`Preview displayed for ${file.name}`);
        };
        reader.onerror = () => { throw new Error('Failed to read file for preview'); };
        reader.readAsDataURL(file);
      } catch (err) {
        console.error(`Preview error for ${file.name}: ${err.message}`);
        throw err;
      }
    }

    async function savePin(anglerName, pin, retries = 5, delay = 1500) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          console.log(`Attempt ${attempt} to save PIN for ${anglerName}`);
          const response = await fetch('https://fish-angler.familyfishingfun2025.workers.dev/update_pin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: anglerName, pin })
          });
          const data = await response.json();
          console.log(`Save PIN response for ${anglerName}:`, data);
          if (!response.ok) throw new Error(data.error || `HTTP ${response.status}`);
          console.log(`PIN saved successfully for ${anglerName}`);
          return true;
        } catch (error) {
          console.error(`Attempt ${attempt} failed to save PIN for ${anglerName}: ${error.message}`);
          if (attempt === retries) return false;
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
      return false;
    }

    async function verifyPin(anglerName, pin, retries = 5, delay = 1500) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          console.log(`Attempt ${attempt} to verify PIN for ${anglerName}, PIN: ${pin}`);
          const response = await fetch('https://fish-angler.familyfishingfun2025.workers.dev/verify_pin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: anglerName, pin })
          });
          const data = await response.json();
          console.log(`Verify PIN response for ${anglerName}:`, data);
          if (!response.ok) throw new Error(data.error || `HTTP ${response.status}`);
          return data.isValid ? true : data.error === "No PIN set for this angler" ? "no_pin" : false;
        } catch (error) {
          console.error(`Attempt ${attempt} failed to verify PIN for ${anglerName}: ${error.message}`);
          if (attempt === retries) {
            console.error(`All retries failed for PIN verification for ${anglerName}`);
            return false;
          }
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
      return false;
    }

    async function fetchAnglerList() {
      try {
        console.log('Fetching angler list from https://fish-angler.familyfishingfun2025.workers.dev/angler_list');
        const response = await fetch('https://fish-angler.familyfishingfun2025.workers.dev/angler_list', { 
          cache: 'no-cache', 
          headers: { 
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          } 
        });
        console.log(`Angler list fetch status: ${response.status}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        const anglers = await response.json();
        console.log('Raw angler list response:', anglers);
        if (!Array.isArray(anglers)) throw new Error('Invalid angler list format: Expected array');
        const filteredAnglers = anglers.map(name => name.replace(/[<>]/g, '')).filter(name => name.length > 0);
        console.log('Filtered angler list:', filteredAnglers);
        return filteredAnglers;
      } catch (error) {
        console.error('Failed to load anglers:', error.message);
        document.getElementById('errorMessage').textContent = `Failed to load anglers: ${error.message}. Please try again later.`;
        document.getElementById('errorMessage').style.display = 'block';
        return [];
      }
    }

    async function populateAnglerDropdown() {
      const anglerSelect = document.getElementById('anglerName');
      const errorMessage = document.getElementById('errorMessage');
      anglerSelect.disabled = true;
      anglerSelect.innerHTML = '<option value="">Loading anglers...</option>';
      try {
        const anglers = await fetchAnglerList();
        console.log('Populating dropdown with anglers:', anglers);
        anglerSelect.disabled = false;
        if (anglers.length === 0) {
          anglerSelect.innerHTML = '<option value="">No anglers registered</option>';
          errorMessage.textContent = 'No registered anglers available. Please join the tournament.';
          errorMessage.style.display = 'block';
          return;
        }
        anglerSelect.innerHTML = '<option value="">Select your name</option>' + anglers.map(name => `<option value="${name}">${name}</option>`).join('');
        const storedAngler = Object.keys(localStorage).find(key => key.startsWith('angler_pin_') && anglers.find(a => a.toLowerCase() === key.replace('angler_pin_', '')));
        if (storedAngler) {
          const anglerName = anglers.find(a => a.toLowerCase() === storedAngler.replace('angler_pin_', ''));
          if (anglerName) { 
            anglerSelect.value = anglerName; 
            console.log(`Auto-selected angler: ${anglerName}`);
            validateForm(); 
          }
        }
      } catch (error) {
        console.error('Failed to populate angler dropdown:', error.message);
        anglerSelect.disabled = false;
        anglerSelect.innerHTML = '<option value="">Error loading anglers</option>';
        errorMessage.textContent = `Error loading anglers: ${error.message}. Please try again later.`;
        errorMessage.style.display = 'block';
      }
    }

    function populateFishCountDropdown() {
      const fishCountSelect = document.getElementById('fishCount');
      fishCountSelect.innerHTML = '<option value="">Select number of fish</option>' + [1, 2, 3, 4, 5].map(num => `<option value="${num}">${num}</option>`).join('');
    }

    async function validateForm() {
      const anglerSelect = document.getElementById('anglerName');
      const fishCountSelect = document.getElementById('fishCount');
      const submitButton = document.getElementById('submitButton');
      const errorMessage = document.getElementById('errorMessage');
      const anglerValid = anglerSelect.value !== '';
      const fishCount = parseInt(fishCountSelect.value) || 0;
      const fishCountValid = fishCount >= 1 && fishCount <= 5;
      let isValid = anglerValid && fishCountValid;
      errorMessage.style.display = 'none';
      if (!anglerValid) { errorMessage.textContent = 'Please select an angler.'; errorMessage.style.display = 'block'; }
      if (!fishCountValid) { errorMessage.textContent = 'Please select a valid number of fish (1-5).'; errorMessage.style.display = 'block'; isValid = false; }
      for (let i = 1; i <= fishCount; i++) {
        const photoInput = document.getElementById(`fishPhoto${i}`);
        const length = document.getElementById(`fishLength${i}`).value;
        const lengthValid = length && !isNaN(parseFloat(length)) && parseFloat(length) > 0;
        const file = photoInput.files[0];
        const fileError = file ? validateFile(file) : 'No photo selected.';
        if (fileError) { isValid = false; errorMessage.textContent = `Fish ${i}: ${fileError}`; errorMessage.style.display = 'block'; break; }
        if (!lengthValid) { isValid = false; errorMessage.textContent = `Fish ${i}: Please enter a valid length.`; errorMessage.style.display = 'block'; break; }
      }
      submitButton.disabled = !isValid;
      return isValid;
    }

    async function handleSubmit(event) {
      event.preventDefault();
      const form = document.getElementById('fishForm');
      const successMessage = document.getElementById('successMessage');
      const loadingMessage = document.getElementById('loadingMessage');
      const errorMessage = document.getElementById('errorMessage');
      const submitButton = document.getElementById('submitButton');
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';
      loadingMessage.style.display = 'block';
      submitButton.disabled = true;
      try {
        const anglerName = document.getElementById('anglerName').value;
        const pinKey = `angler_pin_${anglerName.toLowerCase()}`;
        let storedPin = localStorage.getItem(pinKey);
        console.log(`Stored PIN for ${anglerName}: ${storedPin}`);
        
        // Check if PIN exists in fff-db
        let pinCheck = await verifyPin(anglerName, storedPin || '000000'); // Use dummy PIN if none in localStorage
        console.log(`Initial PIN check result for ${anglerName}: ${pinCheck}`);
        
        let pin;
        if (pinCheck === "no_pin") {
          // No PIN in fff-db, prompt for new PIN
          let validPin = false;
          while (!validPin) {
            pin = prompt(`Welcome, ${anglerName}! Please choose a 6-digit PIN to secure your submissions:`);
            if (pin === null) {
              console.log(`PIN prompt cancelled for ${anglerName}`);
              errorMessage.textContent = 'Submission cancelled. Please provide a PIN to proceed.';
              errorMessage.style.display = 'block';
              throw new Error('PIN prompt cancelled');
            }
            if (!/^\d{6}$/.test(pin)) {
              alert('Please enter a valid 6-digit PIN (numbers only).');
              continue;
            }
            console.log(`Attempting to save new PIN for ${anglerName}: ${pin}`);
            const pinSaved = await savePin(anglerName, pin);
            if (!pinSaved) {
              console.error('Failed to save PIN after retries');
              errorMessage.textContent = 'Failed to save new PIN to database. Please try again or contact support.';
              errorMessage.style.display = 'block';
              throw new Error('Failed to save PIN');
            }
            localStorage.setItem(pinKey, pin);
            console.log(`Stored new PIN in localStorage: ${pinKey} = ${pin}`);
            alert('New PIN saved successfully! Proceeding with submission.');
            storedPin = pin;
            validPin = true;
          }
        } else if (pinCheck === false || !storedPin) {
          // PIN exists in fff-db, verify it
          let validPin = false;
          let attempts = 0;
          const maxAttempts = 10;
          while (!validPin && attempts < maxAttempts) {
            pin = prompt(`Please enter your 6-digit PIN for ${anglerName}:`);
            if (pin === null) {
              console.log(`PIN prompt cancelled for ${anglerName}`);
              errorMessage.textContent = 'Submission cancelled. Please provide a PIN to proceed.';
              errorMessage.style.display = 'block';
              throw new Error('PIN prompt cancelled');
            }
            if (!/^\d{6}$/.test(pin)) {
              alert('Please enter a valid 6-digit PIN (numbers only).');
              attempts++;
              continue;
            }
            console.log(`Verifying PIN for ${anglerName}: ${pin}`);
            const isValidPin = await verifyPin(anglerName, pin);
            if (isValidPin === true) {
              localStorage.setItem(pinKey, pin);
              console.log(`Stored verified PIN in localStorage: ${pinKey} = ${pin}`);
              storedPin = pin;
              validPin = true;
            } else {
              attempts++;
              console.log(`Incorrect PIN attempt ${attempts} for ${anglerName}`);
              alert('Incorrect PIN. Please try again.');
            }
          }
          if (!validPin) {
            console.log(`Max PIN attempts exceeded for ${anglerName}`);
            errorMessage.textContent = 'Too many incorrect PIN attempts. Please contact support.';
            errorMessage.style.display = 'block';
            throw new Error('Too many incorrect PIN attempts');
          }
        }
        
        const formData = new FormData();
        formData.append('name', anglerName);
        formData.append('fishCount', document.getElementById('fishCount').value);
        formData.append('pin', storedPin);
        const fishCount = parseInt(document.getElementById('fishCount').value) || 0;
        for (let i = 1; i <= fishCount; i++) {
          const photoInput = document.getElementById(`fishPhoto${i}`);
          const file = photoInput.files[0];
          if (file) {
            try {
              const resizedFile = await resizeImage(file, 1920, 0.8);
              formData.append(`fishPhoto${i}`, resizedFile);
              formData.append(`fishLength${i}`, document.getElementById(`fishLength${i}`).value);
            } catch (err) {
              console.error(`Failed to process fish ${i} photo: ${err.message}`);
              throw new Error(`Failed to process fish ${i} photo: ${err.message}`);
            }
          }
        }
        console.log(`Submitting form for ${anglerName} with PIN ${storedPin}`);
        const response = await fetch('https://fish-angler.familyfishingfun2025.workers.dev/submit_fish', { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);
        successMessage.textContent = 'Fish submitted successfully! Redirecting to leaderboard...';
        successMessage.style.display = 'block';
        alert('Submission successful! Your fish have been uploaded.');
        form.reset();
        document.getElementById('anglerName').value = anglerName;
        document.getElementById('fishCount').value = '';
        for (let i = 1; i <= 5; i++) {
          const entry = document.getElementById(`fishEntry${i}`);
          entry.style.display = 'none';
          document.getElementById(`preview${i}`).style.display = 'none';
          document.getElementById(`preview${i}`).src = '';
        }
        setTimeout(() => {
          window.location.href = 'https://hackerfrankone.github.io/FamilyFishing/index.html';
        }, 1000);
      } catch (error) {
        console.error('Submission error:', error.message);
        errorMessage.textContent = `Submission failed: ${error.message}`;
        errorMessage.style.display = 'block';
        alert(`Submission failed: ${error.message}`);
      } finally {
        loadingMessage.style.display = 'none';
        validateForm();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      populateAnglerDropdown();
      populateFishCountDropdown();
      document.getElementById('fishForm').addEventListener('submit', handleSubmit);
      document.getElementById('anglerName').addEventListener('change', validateForm);
      document.getElementById('fishCount').addEventListener('change', (e) => {
        const count = parseInt(e.target.value) || 0;
        for (let i = 1; i <= 5; i++) {
          const entry = document.getElementById(`fishEntry${i}`);
          entry.style.display = i <= count ? 'block' : 'none';
          document.getElementById(`preview${i}`).style.display = 'none';
          document.getElementById(`preview${i}`).src = '';
        }
        validateForm();
      });
      for (let i = 1; i <= 5; i++) {
        const photoInput = document.getElementById(`fishPhoto${i}`);
        photoInput?.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          console.log(`Selected: ${file?.name}, Type: ${file?.type}, Size: ${file?.size}`);
          if (file) {
            try {
              const error = validateFile(file);
              if (!error) {
                displayPreview(file, `preview${i}`);
                await validateForm();
              } else {
                console.log(`Validation failed for ${file.name}: ${error}`);
                e.target.value = '';
                document.getElementById('errorMessage').textContent = error;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById(`preview${i}`).style.display = 'none';
                await validateForm();
              }
            } catch (err) {
              console.error(`Photo processing error for ${file.name}: ${err.message}`);
              e.target.value = '';
              document.getElementById('errorMessage').textContent = `Photo error: ${err.message}`;
              document.getElementById('errorMessage').style.display = 'block';
              document.getElementById(`preview${i}`).style.display = 'none';
              await validateForm();
            }
          }
        });
        document.getElementById(`fishLength${i}`)?.addEventListener('input', validateForm);
      }
    });
  </script>
</head>
<body>
  <h1>Submit Your Fish</h1>
  <form id="fishForm" class="submit-form" action="https://fish-angler.familyfishingfun2025.workers.dev/submit_fish" method="POST" enctype="multipart/form-data">
    <label for="anglerName">Angler Name:</label>
    <select id="anglerName" name="name" required><option value="">Loading anglers...</option></select>
    <p id="successMessage" class="success-message"></p>
    <p id="errorMessage" class="error-message"></p>
    <label for="fishCount">Number of Fish (1-5):</label>
    <select id="fishCount" name="fishCount" required><option value="">Select number of fish</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
    <div id="fishEntry1" class="fish-entry">
      <label for="fishPhoto1">Fish 1 Photo (max 10MB):</label>
      <input type="file" id="fishPhoto1" name="fishPhoto1" accept="image/*">
      <img id="preview1" class="preview-image" style="display: none;" alt="Fish 1 Preview">
      <label for="fishLength1">Fish 1 Length (inches):</label>
      <input type="number" id="fishLength1" name="fishLength1" step="0.25" min="0" placeholder="example: 12.75">
    </div>
    <div id="fishEntry2" class="fish-entry" style="display: none;">
      <label for="fishPhoto2">Fish 2 Photo (max 10MB):</label>
      <input type="file" id="fishPhoto2" name="fishPhoto2" accept="image/*">
      <img id="preview2" class="preview-image" style="display: none;" alt="Fish 2 Preview">
      <label for="fishLength2">Fish 2 Length (inches):</label>
      <input type="number" id="fishLength2" name="fishLength2" step="0.25" min="0" placeholder="example: 12.75">
    </div>
    <div id="fishEntry3" class="fish-entry" style="display: none;">
      <label for="fishPhoto3">Fish 3 Photo (max 10MB):</label>
      <input type="file" id="fishPhoto3" name="fishPhoto3" accept="image/*">
      <img id="preview3" class="preview-image" style="display: none;" alt="Fish 3 Preview">
      <label for="fishLength3">Fish 3 Length (inches):</label>
      <input type="number" id="fishLength3" name="fishLength3" step="0.25" min="0" placeholder="example: 12.75">
    </div>
    <div id="fishEntry4" class="fish-entry" style="display: none;">
      <label for="fishPhoto4">Fish 4 Photo (max 10MB):</label>
      <input type="file" id="fishPhoto4" name="fishPhoto4" accept="image/*">
      <img id="preview4" class="preview-image" style="display: none;" alt="Fish 4 Preview">
      <label for="fishLength4">Fish 4 Length (inches):</label>
      <input type="number" id="fishLength4" name="fishLength4" step="0.25" min="0" placeholder="example: 12.75">
    </div>
    <div id="fishEntry5" class="fish-entry" style="display: none;">
      <label for="fishPhoto5">Fish 5 Photo (max 10MB):</label>
      <input type="file" id="fishPhoto5" name="fishPhoto5" accept="image/*">
      <img id="preview5" class="preview-image" style="display: none;" alt="Fish 5 Preview">
      <label for="fishLength5">Fish 5 Length (inches):</label>
      <input type="number" id="fishLength5" name="fishLength5" step="0.25" min="0" placeholder="example: 12.75">
    </div>
    <input type="submit" id="submitButton" value="Submit Fish" disabled>
    <p id="loadingMessage" class="loading-message">Please do not close, uploading picture...</p>
  </form>
</body>
</html>
