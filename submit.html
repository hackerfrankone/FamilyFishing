<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Submit Fish - Family Fishing Fun</title>
  <base href="https://hackerfrankone.github.io/FamilyFishing/">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https://hackerfrankone.github.io https://www.familyfishing.fun https://*.cloudflare.com data:; connect-src 'self' https://hackerfrankone.github.io https://www.familyfishing.fun https://fish-angler.familyfishingfun2025.workers.dev; form-action 'self'; object-src 'none'; base-uri 'self';">
  <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <style>
    body { background-image: url('https://hackerfrankone.github.io/FamilyFishing/images/background.png?v=2'); background-color: #000; background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; min-height: 100vh; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
    h1 { color: #FFD700; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); text-align: center; }
    .submit-form { background: rgba(0, 0, 0, 0.6); padding: 1rem; border-radius: 8px; width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 1rem; }
    label { font-weight: bold; color: #FFD700; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); }
    select, input[type="file"], input[type="number"] { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; background: #fff; color: #000; font-size: 1rem; }
    select:disabled { background: #666; cursor: not-allowed; }
    input[type="submit"] { background-color: #28a745; color: #fff; font-weight: bold; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer; transition: filter 0.3s ease; }
    input[type="submit"]:disabled { background-color: #218838; cursor: not-allowed; filter: brightness(80%); }
    input[type="submit"]:hover:not(:disabled) { filter: brightness(120%); }
    .fish-entry { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem; }
    .success-message, .error-message, .loading-message { font-size: 0.9rem; text-align: center; display: none; }
    .success-message { color: #28a745; }
    .loading-message { color: #FFD700; font-weight: bold; }
    .error-message { color: #ff0000; }
    .preview-image { max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 4px; margin-top: 0.5rem; }
    .add-fish { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #FFD700; font-weight: bold; }
    .add-fish:hover { text-decoration: underline; }
    @media (max-width: 768px) { .submit-form { padding: 0.5rem; } h1 { font-size: 1.5rem; } select, input[type="file"], input[type="number"], input[type="submit"] { font-size: 0.9rem; } .preview-image { max-width: 80px; max-height: 80px; } }
  </style>
  <script>
    async function fetchAnglerList() {
      try {
        const res = await fetch('https://fish-angler.familyfishingfun2025.workers.dev/list_anglers', { headers: { Accept: 'application/json' }});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        return data.anglers || [];
      } catch (err) {
        console.error('Failed to fetch anglers:', err);
        return [];
      }
    }

    async function populateAnglerDropdown() {
      const select = document.getElementById('anglerName');
      select.innerHTML = '<option value="">Select an angler</option>';
      const anglers = await fetchAnglerList();

      if (anglers.length > 0) {
        anglers.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
      } else {
        // fallback default names
        ['John', 'Sarah', 'Mike'].forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
      }
    }

    function addFishEntry(index) {
      const container = document.getElementById('fishEntries');
      const entry = document.createElement('div');
      entry.className = 'fish-entry';
      entry.innerHTML = `
        <label for="fishPhoto${index}">Fish Photo ${index}:</label>
        <input type="file" id="fishPhoto${index}" name="fishPhoto${index}" accept="image/*" required>
        <label for="fishLength${index}">Length (inches):</label>
        <input type="number" id="fishLength${index}" name="fishLength${index}" min="1" required>
      `;
      container.appendChild(entry);
    }

    function validateForm() {
      const angler = document.getElementById('anglerName').value;
      const fishEntries = document.querySelectorAll('.fish-entry input[type="file"]');
      const submitButton = document.getElementById('submitButton');
      submitButton.disabled = !(angler && fishEntries.length > 0 && Array.from(fishEntries).every(input => input.files.length > 0));
    }

    async function handleSubmit(event) {
      event.preventDefault();
      alert('Form submitted!'); // placeholder
    }

    document.addEventListener('DOMContentLoaded', () => {
      populateAnglerDropdown();
      addFishEntry(1);
      document.getElementById('fishForm').addEventListener('submit', handleSubmit);
      document.getElementById('anglerName').addEventListener('change', validateForm);
      document.getElementById('addFish').addEventListener('click', () => {
        const fishEntries = document.querySelectorAll('.fish-entry');
        if (fishEntries.length < 5) {
          addFishEntry(fishEntries.length + 1);
          validateForm();
        } else {
          document.getElementById('errorMessage').textContent = 'Maximum of 5 fish allowed.';
          document.getElementById('errorMessage').style.display = 'block';
        }
      });
    });
  </script>
</head>
<body>
  <h1>Submit Your Fish</h1>
  <form id="fishForm" class="submit-form" method="POST" enctype="multipart/form-data">
    <label for="anglerName">Angler Name:</label>
    <select id="anglerName" name="name" required><option value="">Loading anglers...</option></select>
    <p id="successMessage" class="success-message"></p>
    <p id="errorMessage" class="error-message"></p>
    <div id="fishEntries"></div>
    <div class="add-fish" id="addFish"><span style="font-size: 1.5rem;">+</span> Add picture</div>
    <input type="submit" id="submitButton" value="Submit Fish" disabled>
    <p id="loadingMessage" class="loading-message">Please do not close, uploading picture...</p>
  </form>
</body>
</html>
