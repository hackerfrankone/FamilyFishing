<!DOCTYPE html>
   <html lang="en">
   <head>
     <meta charset="UTF-8">
     <title>Submit Fish - Family Fishing Fun</title>
     <base href="https://www.familyfishing.fun/">
     <link rel="icon" type="image/x-icon" href="https://www.familyfishing.fun/images/favicon.jpg">
     <link rel="apple-touch-icon" href="https://www.familyfishing.fun/images/favicon.png">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https://www.familyfishing.fun https://*.cloudflare.com data:; connect-src 'self' https://www.familyfishing.fun https://fish-angler.familyfishingfun2025.workers.dev; form-action 'self'; object-src 'none'; base-uri 'self';">
     <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
     <meta http-equiv="X-Content-Type-Options" content="nosniff">
     <meta http-equiv="Referrer-Policy" content="no-referrer">
     <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
     <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
     <style>
       body {
         background-image: url('https://www.familyfishing.fun/images/background.png?v=2');
         background-color: #000;
         background-size: cover;
         background-position: center;
         background-repeat: no-repeat;
         background-attachment: fixed;
         min-height: 100vh;
         color: #fff;
         font-family: Arial, sans-serif;
         margin: 0;
         padding: 20px;
         display: flex;
         flex-direction: column;
         align-items: center;
       }
       .container {
         max-width: 600px;
         width: 100%;
         padding: 20px;
         background-color: rgba(0, 0, 0, 0.7);
         border-radius: 8px;
         text-align: center;
       }
       h1 {
         color: #FFD700;
         font-size: 2rem;
         text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
         margin-bottom: 1rem;
       }
       form {
         display: flex;
         flex-direction: column;
         gap: 1rem;
         margin-bottom: 2rem;
       }
       label {
         color: #FFD700;
         font-weight: bold;
         text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
       }
       select, input[type="text"], input[type="file"], input[type="number"] {
         padding: 0.5rem;
         border: 1px solid #FFD700;
         border-radius: 4px;
         background-color: rgba(255, 255, 255, 0.1);
         color: #fff;
         font-size: 1rem;
       }
       select:disabled, input[type="text"]:disabled, input[type="number"]:disabled {
         background: rgba(255, 255, 255, 0.3);
         cursor: not-allowed;
       }
       input[type="submit"] {
         background-color: #FFD140;
         color: #000;
         font-weight: bold;
         padding: 0.5rem;
         border: none;
         border-radius: 4px;
         cursor: pointer;
         transition: background-color 0.3s ease;
       }
       input[type="submit"]:hover:not(:disabled) {
         background-color: #ffeb3b;
       }
       input[type="submit"]:disabled {
         background-color: #FFD140;
         filter: brightness(80%);
         cursor: not-allowed;
       }
       .fish-entry {
         display: flex;
         flex-direction: column;
         gap: 0.5rem;
         margin-bottom: 0.5rem;
       }
       .message {
         margin-top: 1rem;
         font-size: 1.1rem;
         text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
       }
       .success {
         color: #00ff00;
       }
       .error {
         color: #ff0000;
       }
       .loading {
         color: #FFD700;
         font-weight: bold;
       }
       .preview-image {
         max-width: 100px;
         max-height: 100px;
         object-fit: cover;
         border-radius: 4px;
         margin-top: 0.5rem;
       }
       .keypad {
         display: none;
         position: fixed;
         bottom: 20px;
         left: 50%;
         transform: translateX(-50%);
         background-color: rgba(0, 0, 0, 0.9);
         padding: 10px;
         border-radius: 8px;
         box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
         z-index: 1000;
       }
       .keypad button {
         width: 50px;
         height: 50px;
         margin: 5px;
         font-size: 1.2rem;
         background-color: #FFD140;
         color: #000;
         border: none;
         border-radius: 4px;
         cursor: pointer;
       }
       .keypad button:hover {
         background-color: #ffeb3b;
       }
       @media (max-width: 768px) {
         .container {
           padding: 10px;
         }
         h1 {
           font-size: 1.5rem;
         }
         select, input[type="text"], input[type="file"], input[type="number"], input[type="submit"] {
           font-size: 0.9rem;
         }
         .preview-image {
           max-width: 80px;
           max-height: 80px;
         }
         .keypad button {
           width: 40px;
           height: 40px;
           font-size: 1rem;
         }
       }
     </style>
   </head>
   <body>
     <div class="container">
       <h1>Submit Your Fish</h1>
       <form id="pinForm" action="https://fish-angler.familyfishingfun2025.workers.dev/verify_pin" method="POST">
         <label for="anglerName">Angler Name:</label>
         <select id="anglerName" name="name" required>
           <option value="">Loading anglers...</option>
         </select>
         <label for="pin">6-Digit PIN:</label>
         <input type="text" id="pin" name="pin" pattern="\d{6}" title="PIN must be 6 digits" required readonly>
         <input type="submit" value="Verify PIN">
       </form>
       <div id="pinMessage" class="message"></div>
       <form id="fishForm" action="https://fish-angler.familyfishingfun2025.workers.dev/submit_fish" method="POST" enctype="multipart/form-data" style="display: none;">
         <input type="hidden" id="fishAnglerName" name="name">
         <input type="hidden" id="fishPin" name="pin">
         <label for="fishCount">Number of Fish (1-5):</label>
         <select id="fishCount" name="fishCount" required>
           <option value="">Select number of fish</option>
           <option value="1">1</option>
           <option value="2">2</option>
           <option value="3">3</option>
           <option value="4">4</option>
           <option value="5">5</option>
         </select>
         <div id="fishEntry1" class="fish-entry">
           <label for="fishPhoto1">Fish 1 Photo (JPEG/PNG, max 5MB):</label>
           <input type="file" id="fishPhoto1" name="fishPhoto1" accept="image/jpeg,image/png">
           <img id="preview1" class="preview-image" style="display: none;" alt="Fish 1 Preview">
           <label for="fishLength1">Fish 1 Length (inches):</label>
           <input type="number" id="fishLength1" name="fishLength1" step="0.25" min="0" placeholder="example: 12.75">
         </div>
         <div id="fishEntry2" class="fish-entry" style="display: none;">
           <label for="fishPhoto2">Fish 2 Photo (JPEG/PNG, max 5MB):</label>
           <input type="file" id="fishPhoto2" name="fishPhoto2" accept="image/jpeg,image/png">
           <img id="preview2" class="preview-image" style="display: none;" alt="Fish 2 Preview">
           <label for="fishLength2">Fish 2 Length (inches):</label>
           <input type="number" id="fishLength2" name="fishLength2" step="0.25" min="0" placeholder="example: 12.75">
         </div>
         <div id="fishEntry3" class="fish-entry" style="display: none;">
           <label for="fishPhoto3">Fish 3 Photo (JPEG/PNG, max 5MB):</label>
           <input type="file" id="fishPhoto3" name="fishPhoto3" accept="image/jpeg,image/png">
           <img id="preview3" class="preview-image" style="display: none;" alt="Fish 3 Preview">
           <label for="fishLength3">Fish 3 Length (inches):</label>
           <input type="number" id="fishLength3" name="fishLength3" step="0.25" min="0" placeholder="example: 12.75">
         </div>
         <div id="fishEntry4" class="fish-entry" style="display: none;">
           <label for="fishPhoto4">Fish 4 Photo (JPEG/PNG, max 5MB):</label>
           <input type="file" id="fishPhoto4" name="fishPhoto4" accept="image/jpeg,image/png">
           <img id="preview4" class="preview-image" style="display: none;" alt="Fish 4 Preview">
           <label for="fishLength4">Fish 4 Length (inches):</label>
           <input type="number" id="fishLength4" name="fishLength4" step="0.25" min="0" placeholder="example: 12.75">
         </div>
         <div id="fishEntry5" class="fish-entry" style="display: none;">
           <label for="fishPhoto5">Fish 5 Photo (JPEG/PNG, max 5MB):</label>
           <input type="file" id="fishPhoto5" name="fishPhoto5" accept="image/jpeg,image/png">
           <img id="preview5" class="preview-image" style="display: none;" alt="Fish 5 Preview">
           <label for="fishLength5">Fish 5 Length (inches):</label>
           <input type="number" id="fishLength5" name="fishLength5" step="0.25" min="0" placeholder="example: 12.75">
         </div>
         <input type="submit" id="submitButton" value="Submit Fish" disabled>
       </form>
       <div id="fishMessage" class="message"></div>
       <div id="keypad" class="keypad">
         <button type="button" onclick="addPinDigit('1')">1</button>
         <button type="button" onclick="addPinDigit('2')">2</button>
         <button type="button" onclick="addPinDigit('3')">3</button>
         <button type="button" onclick="addPinDigit('4')">4</button>
         <button type="button" onclick="addPinDigit('5')">5</button>
         <button type="button" onclick="addPinDigit('6')">6</button>
         <button type="button" onclick="addPinDigit('7')">7</button>
         <button type="button" onclick="addPinDigit('8')">8</button>
         <button type="button" onclick="addPinDigit('9')">9</button>
         <button type="button" onclick="addPinDigit('0')">0</button>
         <button type="button" onclick="clearPin()">Clear</button>
       </div>
     </div>
     <script>
       async function hashPin(pin) {
         const encoder = new TextEncoder();
         const data = encoder.encode(pin);
         const hash = await crypto.subtle.digest('SHA-256', data);
         return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
       }

       async function resizeImage(file, maxDimension = 1920, quality = 0.8) {
         return new Promise((resolve, reject) => {
           const img = new Image();
           const reader = new FileReader();
           reader.onload = (e) => {
             img.src = e.target.result;
             img.onload = () => {
               const canvas = document.createElement('canvas');
               let width = img.width;
               let height = img.height;
               if (width > height) { if (width > maxDimension) { height = Math.round((height * maxDimension) / width); width = maxDimension; } }
               else { if (height > maxDimension) { width = Math.round((width * maxDimension) / height); height = maxDimension; } }
               canvas.width = width;
               canvas.height = height;
               const ctx = canvas.getContext('2d');
               ctx.drawImage(img, 0, 0, width, height);
               canvas.toBlob((blob) => resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() })), 'image/jpeg', quality);
             };
             img.onerror = () => reject(new Error('Failed to load image'));
           };
           reader.onerror = () => reject(new Error('Failed to read file'));
           reader.readAsDataURL(file);
         });
       }

       function validateFile(file) {
         const validTypes = ['image/jpeg', 'image/png'];
         const maxSize = 5 * 1024 * 1024;
         if (!validTypes.includes(file.type)) return 'Only JPEG and PNG images are allowed.';
         if (file.size > maxSize) return 'File size exceeds 5MB limit.';
         return null;
       }

       function displayPreview(file, previewId) {
         const preview = document.getElementById(previewId);
         const reader = new FileReader();
         reader.onload = (e) => { preview.src = e.target.result; preview.style.display = 'block'; };
         reader.readAsDataURL(file);
       }

       function addPinDigit(digit) {
         const pinInput = document.getElementById('pin');
         if (pinInput.value.length < 6) {
           pinInput.value += digit;
         }
         if (pinInput.value.length === 6) {
           document.getElementById('keypad').style.display = 'none';
         }
       }

       function clearPin() {
         document.getElementById('pin').value = '';
         document.getElementById('keypad').style.display = 'block';
       }

       async function fetchAnglerList() {
         try {
           console.log('Fetching angler list');
           const response = await fetch('https://fish-angler.familyfishingfun2025.workers.dev/angler_list', {
             cache: 'no-cache',
             headers: { 'Accept': 'application/json' }
           });
           if (!response.ok) throw new Error(`HTTP ${response.status}`);
           const anglers = await response.json();
           if (!Array.isArray(anglers)) throw new Error('Invalid angler list format');
           console.log('Angler list fetched:', anglers);
           return anglers.map(name => name.replace(/[<>]/g, '')).filter(name => name.length > 0);
         } catch (error) {
           console.error('Failed to load anglers:', error.message);
           document.getElementById('pinMessage').textContent = 'Failed to load anglers. Please try again later.';
           document.getElementById('pinMessage').className = 'message error';
           return [];
         }
       }

       async function populateAnglerDropdown() {
         const anglerSelect = document.getElementById('anglerName');
         const pinMessage = document.getElementById('pinMessage');
         anglerSelect.disabled = true;
         anglerSelect.innerHTML = '<option value="">Loading anglers...</option>';
         const anglers = await fetchAnglerList();
         anglerSelect.disabled = false;
         if (anglers.length === 0) {
           anglerSelect.innerHTML = '<option value="">No anglers registered</option>';
           pinMessage.textContent = 'No registered anglers available. Please join the tournament.';
           pinMessage.className = 'message error';
           return;
         }
         anglerSelect.innerHTML = '<option value="">Select your name</option>' + anglers.map(name => `<option value="${name}">${name}</option>`).join('');
         const storedAngler = Object.keys(localStorage).find(key => key.startsWith('angler_pin_') && anglers.find(a => a.toLowerCase() === key.replace('angler_pin_', '')));
         if (storedAngler) {
           const anglerName = anglers.find(a => a.toLowerCase() === storedAngler.replace('angler_pin_', ''));
           if (anglerName) {
             anglerSelect.value = anglerName;
             console.log(`Auto-selected angler: ${anglerName}`);
             verifyStoredPin(anglerName, localStorage.getItem(storedAngler));
           }
         }
       }

       function populateFishCountDropdown() {
         const fishCountSelect = document.getElementById('fishCount');
         fishCountSelect.innerHTML = '<option value="">Select number of fish</option>' + [1, 2, 3, 4, 5].map(num => `<option value="${num}">${num}</option>`).join('');
       }

       async function validateForm() {
         const fishCountSelect = document.getElementById('fishCount');
         const submitButton = document.getElementById('submitButton');
         const fishMessage = document.getElementById('fishMessage');
         const fishCount = parseInt(fishCountSelect.value) || 0;
         let isValid = fishCount >= 1 && fishCount <= 5;
         fishMessage.style.display = 'none';
         if (!fishCount) {
           fishMessage.textContent = 'Please select a valid number of fish (1-5).';
           fishMessage.className = 'message error';
           fishMessage.style.display = 'block';
           isValid = false;
         }
         for (let i = 1; i <= fishCount; i++) {
           const photoInput = document.getElementById(`fishPhoto${i}`);
           const length = document.getElementById(`fishLength${i}`).value;
           const lengthValid = length && !isNaN(parseFloat(length)) && parseFloat(length) > 0;
           const file = photoInput.files[0];
           const fileError = file ? validateFile(file) : 'No photo selected.';
           if (fileError) {
             isValid = false;
             fishMessage.textContent = `Fish ${i}: ${fileError}`;
             fishMessage.className = 'message error';
             fishMessage.style.display = 'block';
             break;
           }
           if (!lengthValid) {
             isValid = false;
             fishMessage.textContent = `Fish ${i}: Please enter a valid length.`;
             fishMessage.className = 'message error';
             fishMessage.style.display = 'block';
             break;
           }
         }
         submitButton.disabled = !isValid;
         return isValid;
       }

       async function verifyStoredPin(anglerName, hashedPin) {
         const pinMessage = document.getElementById('pinMessage');
         const fishForm = document.getElementById('fishForm');
         const pinForm = document.getElementById('pinForm');
         if (!hashedPin) return;
         pinMessage.textContent = 'Verifying stored PIN...';
         pinMessage.className = 'message loading';
         try {
           const pinInput = document.getElementById('pin').value;
           const hashedInputPin = pinInput ? await hashPin(pinInput) : null;
           if (hashedPin === hashedInputPin) {
             pinMessage.textContent = 'PIN verified, please submit your fish.';
             pinMessage.className = 'message success';
             document.getElementById('fishAnglerName').value = anglerName;
             document.getElementById('fishPin').value = pinInput;
             fishForm.style.display = 'block';
             pinForm.style.display = 'none';
           } else {
             const response = await fetch('https://fish-angler.familyfishingfun2025.workers.dev/verify_pin', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ name: anglerName, pin: pinInput || '000000' })
             });
             const data = await response.json();
             if (!response.ok) throw new Error(data.error || `HTTP ${response.status}`);
             if (data.isValid) {
               localStorage.setItem(`angler_pin_${anglerName.toLowerCase()}`, hashedPin);
               pinMessage.textContent = 'PIN verified, please submit your fish.';
               pinMessage.className = 'message success';
               document.getElementById('fishAnglerName').value = anglerName;
               document.getElementById('fishPin').value = pinInput;
               fishForm.style.display = 'block';
               pinForm.style.display = 'none';
             } else if (data.error === 'No PIN set for this angler') {
               promptForNewPin(anglerName, true);
             } else {
               pinMessage.textContent = 'Stored PIN is invalid. Please enter your PIN.';
               pinMessage.className = 'message error';
               localStorage.removeItem(`angler_pin_${anglerName.toLowerCase()}`);
             }
           }
         } catch (error) {
           console.error('Stored PIN verification error:', error.message);
           pinMessage.textContent = 'Error verifying stored PIN. Please enter your PIN.';
           pinMessage.className = 'message error';
           localStorage.removeItem(`angler_pin_${anglerName.toLowerCase()}`);
         }
       }

       async function promptForNewPin(anglerName, isFirstSubmission) {
         const pinMessage = document.getElementById('pinMessage');
         const fishForm = document.getElementById('fishForm');
         const pinForm = document.getElementById('pinForm');
         const promptMessage = isFirstSubmission ? `Welcome, ${anglerName}! Please choose a 6-digit PIN to secure your submissions:` : `No PIN found for ${anglerName}. Please set a new 6-digit PIN:`;
         let pin;
         let validPin = false;
         while (!validPin) {
           pin = prompt(promptMessage);
           if (pin === null) {
             pinMessage.textContent = 'Submission cancelled. Please provide a PIN to proceed.';
             pinMessage.className = 'message error';
             return;
           }
           if (!/^\d{6}$/.test(pin)) {
             alert('Please enter a valid 6-digit PIN (numbers only).');
             continue;
           }
           pinMessage.textContent = 'Saving new PIN...';
           pinMessage.className = 'message loading';
           try {
             const response = await fetch('https://fish-angler.familyfishingfun2025.workers.dev/update_pin', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ name: anglerName, pin })
             });
             const data = await response.json();
             if (!response.ok) throw new Error(data.error || `HTTP ${response.status}`);
             const hashedPin = await hashPin(pin);
             localStorage.setItem(`angler_pin_${anglerName.toLowerCase()}`, hashedPin);
             pinMessage.textContent = 'New PIN saved successfully! Please submit your fish.';
             pinMessage.className = 'message success';
             document.getElementById('fishAnglerName').value = anglerName;
             document.getElementById('fishPin').value = pin;
             fishForm.style.display = 'block';
             pinForm.style.display = 'none';
             validPin = true;
           } catch (error) {
             console.error('Save PIN error:', error.message);
             pinMessage.textContent = error.message === 'PIN already set for this angler' ? 'A PIN is already set for this angler. Please enter the existing PIN.' : 'Failed to save PIN. Please try again.';
             pinMessage.className = 'message error';
           }
         }
       }

       document.addEventListener('DOMContentLoaded', () => {
         populateAnglerDropdown();
         populateFishCountDropdown();
         const pinForm = document.getElementById('pinForm');
         const fishForm = document.getElementById('fishForm');
         const pinMessage = document.getElementById('pinMessage');
         const fishMessage = document.getElementById('fishMessage');
         const pinInput = document.getElementById('pin');
         const keypad = document.getElementById('keypad');

         pinInput.addEventListener('click', () => {
           keypad.style.display = 'block';
         });

         document.addEventListener('click', (e) => {
           if (!pinInput.contains(e.target) && !keypad.contains(e.target)) {
             keypad.style.display = 'none';
           }
         });

         pinForm.addEventListener('submit', async (e) => {
           e.preventDefault();
           pinMessage.textContent = 'Verifying PIN...';
           pinMessage.className = 'message loading';
           const anglerName = document.getElementById('anglerName').value;
           const pin = document.getElementById('pin').value;
           try {
             const response = await fetch(pinForm.action, {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ name: anglerName, pin })
             });
             const data = await response.json();
             if (!response.ok) throw new Error(data.error || `HTTP ${response.status}`);
             if (data.isValid) {
               const hashedPin = await hashPin(pin);
               localStorage.setItem(`angler_pin_${anglerName.toLowerCase()}`, hashedPin);
               pinMessage.textContent = 'PIN verified, please submit your fish.';
               pinMessage.className = 'message success';
               document.getElementById('fishAnglerName').value = anglerName;
               document.getElementById('fishPin').value = pin;
               fishForm.style.display = 'block';
               pinForm.style.display = 'none';
               keypad.style.display = 'none';
             } else {
               const isFirstSubmission = await checkFirstSubmission(anglerName);
               promptForNewPin(anglerName, isFirstSubmission);
             }
           } catch (error) {
             console.error('PIN verification error:', error.message);
             pinMessage.textContent = error.message || 'Error verifying PIN. Please try again.';
             pinMessage.className = 'message error';
           }
         });

         fishForm.addEventListener('submit', async (e) => {
           e.preventDefault();
           fishMessage.textContent = 'Submitting fish...';
           fishMessage.className = 'message loading';
           const formData = new FormData();
           const anglerName = document.getElementById('fishAnglerName').value;
           const pin = document.getElementById('fishPin').value;
           const fishCount = parseInt(document.getElementById('fishCount').value) || 0;
           formData.append('name', anglerName);
           formData.append('pin', pin);
           formData.append('fishCount', fishCount);
           for (let i = 1; i <= fishCount; i++) {
             const photoInput = document.getElementById(`fishPhoto${i}`);
             const file = photoInput.files[0];
             if (file) {
               const resizedFile = await resizeImage(file, 1920, 0.8);
               formData.append(`fishPhoto${i}`, resizedFile);
               formData.append(`fishLength${i}`, document.getElementById(`fishLength${i}`).value);
             }
           }
           try {
             const response = await fetch(fishForm.action, {
               method: 'POST',
               body: formData,
               headers: { 'Accept': 'application/json' }
             });
             const result = await response.json();
             if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);
             fishMessage.textContent = 'Fish submitted successfully! Redirecting to leaderboard...';
             fishMessage.className = 'message success';
             fishForm.reset();
             document.getElementById('anglerName').value = anglerName;
             document.getElementById('fishCount').value = '';
             for (let i = 1; i <= 5; i++) {
               document.getElementById(`fishEntry${i}`).style.display = 'none';
               document.getElementById(`preview${i}`).style.display = 'none';
               document.getElementById(`preview${i}`).src = '';
             }
             setTimeout(() => {
               window.location.href = 'https://www.familyfishing.fun/index.html';
             }, 1000);
           } catch (error) {
             console.error('Fish submission error:', error.message);
             fishMessage.textContent = `Submission failed: ${error.message}`;
             fishMessage.className = 'message error';
           }
         });

         document.getElementById('fishCount').addEventListener('change', (e) => {
           const count = parseInt(e.target.value) || 0;
           for (let i = 1; i <= 5; i++) {
             const entry = document.getElementById(`fishEntry${i}`);
             entry.style.display = i <= count ? 'block' : 'none';
             document.getElementById(`preview${i}`).style.display = 'none';
             document.getElementById(`preview${i}`).src = '';
           }
           validateForm();
         });

         for (let i = 1; i <= 5; i++) {
           const photoInput = document.getElementById(`fishPhoto${i}`);
           photoInput?.addEventListener('change', async (e) => {
             const file = e.target.files[0];
             if (file) {
               const error = validateFile(file);
               if (!error) {
                 displayPreview(file, `preview${i}`);
                 await validateForm();
               } else {
                 e.target.value = '';
                 fishMessage.textContent = error;
                 fishMessage.className = 'message error';
                 fishMessage.style.display = 'block';
                 document.getElementById(`preview${i}`).style.display = 'none';
                 await validateForm();
               }
             }
           });
           document.getElementById(`fishLength${i}`)?.addEventListener('input', validateForm);
         }
       });

       async function checkFirstSubmission(anglerName) {
         try {
           console.log(`Checking first submission for ${anglerName}`);
           const response = await fetch(`https://fish-angler.familyfishingfun2025.workers.dev/check_first_submission?angler=${encodeURIComponent(anglerName)}`, {
             cache: 'no-cache',
             headers: { 'Accept': 'application/json' }
           });
           if (!response.ok) throw new Error(`HTTP ${response.status}`);
           const data = await response.json();
           console.log(`First submission check for ${anglerName}: ${data.isFirstSubmission}`);
           return data.isFirstSubmission;
         } catch (error) {
           console.error(`Failed to check first submission for ${anglerName}: ${error.message}`);
           return true;
         }
       }
     </script>
   </body>
   </html>
