<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Submit Fish - Family Fishing Fun</title>
  <base href="https://hackerfrankone.github.io/FamilyFishing/">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https://hackerfrankone.github.io https://www.familyfishing.fun https://*.cloudflare.com data:; connect-src 'self' https://hackerfrankone.github.io https://www.familyfishing.fun https://fish-angler.familyfishingfun2025.workers.dev; form-action 'self'; object-src 'none'; base-uri 'self';">
  <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <style>
    body { background-image: url('https://hackerfrankone.github.io/FamilyFishing/images/background.png?v=2'); background-color: #000; background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; min-height: 100vh; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
    h1 { color: #FFD700; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); text-align: center; }
    .submit-form { background: rgba(0, 0, 0, 0.6); padding: 1rem; border-radius: 8px; width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 1rem; }
    label { font-weight: bold; color: #FFD700; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); }
    select, input[type="file"], input[type="number"] { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; background: #fff; color: #000; font-size: 1rem; }
    select:disabled { background: #666; cursor: not-allowed; }
    input[type="submit"] { background-color: #28a745; color: #fff; font-weight: bold; border: none; padding: 0.75rem; border-radius: 4px; cursor: pointer; transition: filter 0.3s ease; }
    input[type="submit"]:disabled { background-color: #218838; cursor: not-allowed; filter: brightness(80%); }
    input[type="submit"]:hover:not(:disabled) { filter: brightness(120%); }
    .fish-entry { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem; }
    .success-message, .error-message, .loading-message { font-size: 0.9rem; text-align: center; display: none; }
    .success-message { color: #28a745; }
    .loading-message { color: #FFD700; font-weight: bold; }
    .error-message { color: #ff0000; }
    .preview-image { max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 4px; margin-top: 0.5rem; }
    .add-fish { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #FFD700; font-weight: bold; }
    .add-fish:hover { text-decoration: underline; }
    @media (max-width: 768px) { .submit-form { padding: 0.5rem; } h1 { font-size: 1.5rem; } select, input[type="file"], input[type="number"], input[type="submit"] { font-size: 0.9rem; } .preview-image { max-width: 80px; max-height: 80px; } }
  </style>
  <script>
    /* unchanged helper functions: resizeImage, validateFile, displayPreview, savePin, verifyPin, checkFirstSubmission, fetchAnglerList, populateAnglerDropdown, addFishEntry, validateForm */
    /* ... keep your original helper functions here exactly as you had them ... */

    async function handleSubmit(event) {
      event.preventDefault();
      const successMessage = document.getElementById('successMessage');
      const loadingMessage = document.getElementById('loadingMessage');
      const errorMessage = document.getElementById('errorMessage');
      const submitButton = document.getElementById('submitButton');

      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';
      loadingMessage.style.display = 'block';
      submitButton.disabled = true;

      try {
        const anglerName = document.getElementById('anglerName').value;
        const pinKey = `angler_pin_${anglerName.toLowerCase()}`;
        let storedPin = localStorage.getItem(pinKey);
        const isFirstSubmission = await checkFirstSubmission(anglerName);

        if (!storedPin) {
          let pin;
          let validPin = false;
          const promptMessage = isFirstSubmission
            ? `Welcome, ${anglerName}! Please choose a 6-digit PIN to secure your submissions:`
            : `No PIN found for ${anglerName}. Please set a new 6-digit PIN:`;
          while (!validPin) {
            pin = prompt(promptMessage);
            if (pin === null) {
              errorMessage.textContent = 'Submission cancelled. Please provide a PIN to proceed.';
              errorMessage.style.display = 'block';
              throw new Error('PIN prompt cancelled');
            }
            if (!/^\d{6}$/.test(pin)) {
              alert('Please enter a valid 6-digit PIN (numbers only).');
              continue;
            }
            const pinSaved = await savePin(anglerName, pin);
            if (!pinSaved) {
              errorMessage.textContent = 'Failed to save new PIN to database. Please try again.';
              errorMessage.style.display = 'block';
              throw new Error('Failed to save PIN');
            }
            localStorage.setItem(pinKey, pin);
            alert('New PIN saved successfully! Proceeding with submission.');
            storedPin = pin;
            validPin = true;
          }
        }

        const formData = new FormData();
        formData.append('name', anglerName);
        formData.append('pin', storedPin);

        const fishEntries = document.querySelectorAll('.fish-entry');
        formData.append('fishCount', fishEntries.length);

        // FIX: Await each resize before sending
        for (let index = 0; index < fishEntries.length; index++) {
          const i = index + 1;
          const photoInput = document.getElementById(`fishPhoto${i}`);
          const file = photoInput.files[0];
          if (file) {
            const resizedFile = await resizeImage(file, 1920, 0.8);
            formData.append(`fishPhoto${i}`, resizedFile);
            formData.append(`fishLength${i}`, document.getElementById(`fishLength${i}`).value);
          }
        }

        const response = await fetch('https://fish-angler.familyfishingfun2025.workers.dev/submit_fish', {
          method: 'POST',
          body: formData,
          headers: { 'Accept': 'application/json' }
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);

        successMessage.textContent = 'Fish submitted successfully! Redirecting to leaderboard...';
        successMessage.style.display = 'block';
        alert('Submission successful!');
        document.getElementById('fishForm').reset();
        document.getElementById('anglerName').value = anglerName;
        document.getElementById('fishEntries').innerHTML = '';
        addFishEntry(1);
        setTimeout(() => {
          window.location.href = 'https://hackerfrankone.github.io/FamilyFishing/index.html';
        }, 1000);
      } catch (error) {
        errorMessage.textContent = `Submission failed: ${error.message}`;
        errorMessage.style.display = 'block';
        alert(`Submission failed: ${error.message}`);
      } finally {
        loadingMessage.style.display = 'none';
        validateForm();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      populateAnglerDropdown();
      addFishEntry(1);
      document.getElementById('fishForm').addEventListener('submit', handleSubmit);
      document.getElementById('anglerName').addEventListener('change', validateForm);
      document.getElementById('addFish').addEventListener('click', () => {
        const fishEntries = document.querySelectorAll('.fish-entry');
        if (fishEntries.length < 5) {
          addFishEntry(fishEntries.length + 1);
          validateForm();
        } else {
          document.getElementById('errorMessage').textContent = 'Maximum of 5 fish allowed.';
          document.getElementById('errorMessage').style.display = 'block';
        }
      });
    });
  </script>
</head>
<body>
  <h1>Submit Your Fish</h1>
  <form id="fishForm" class="submit-form" action="https://fish-angler.familyfishingfun2025.workers.dev/submit_fish" method="POST" enctype="multipart/form-data">
    <label for="anglerName">Angler Name:</label>
    <select id="anglerName" name="name" required><option value="">Loading anglers...</option></select>
    <p id="successMessage" class="success-message"></p>
    <p id="errorMessage" class="error-message"></p>
    <div id="fishEntries"></div>
    <div class="add-fish" id="addFish"><span style="font-size: 1.5rem;">+</span> Add picture</div>
    <input type="submit" id="submitButton" value="Submit Fish" disabled>
    <p id="loadingMessage" class="loading-message">Please do not close, uploading picture...</p>
  </form>
</body>
</html>
